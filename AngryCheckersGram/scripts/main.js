// Generated by Construct, the game and animation creation tool
// Visit: https://www.construct.net

// workers/domHandler.js
"use strict";window.DOMHandler=class{constructor(t,i){this._iRuntime=t,this._componentId=i,this._hasTickCallback=!1,this._tickCallback=()=>this.Tick()}Attach(){}PostToRuntime(t,i,e,s){this._iRuntime.PostToRuntimeComponent(this._componentId,t,i,e,s)}PostToRuntimeAsync(t,i,e,s){return this._iRuntime.PostToRuntimeComponentAsync(this._componentId,t,i,e,s)}_PostToRuntimeMaybeSync(t,i,e){this._iRuntime.UsesWorker()?this.PostToRuntime(t,i,e):this._iRuntime._GetLocalRuntime()["_OnMessageFromDOM"]({"type":"event","component":this._componentId,"handler":t,"dispatchOpts":e||null,"data":i,"responseId":null})}AddRuntimeMessageHandler(t,i){this._iRuntime.AddRuntimeComponentMessageHandler(this._componentId,t,i)}AddRuntimeMessageHandlers(t){for(const[i,e]of t)this.AddRuntimeMessageHandler(i,e)}GetRuntimeInterface(){return this._iRuntime}GetComponentID(){return this._componentId}_StartTicking(){this._hasTickCallback||(this._iRuntime._AddRAFCallback(this._tickCallback),this._hasTickCallback=!0)}_StopTicking(){this._hasTickCallback&&(this._iRuntime._RemoveRAFCallback(this._tickCallback),this._hasTickCallback=!1)}Tick(){}},window.RateLimiter=class{constructor(t,i){this._callback=t,this._interval=i,this._timerId=-1,this._lastCallTime=-1/0,this._timerCallFunc=()=>this._OnTimer(),this._ignoreReset=!1,this._canRunImmediate=!1}SetCanRunImmediate(t){this._canRunImmediate=!!t}Call(){if(-1===this._timerId){const t=Date.now(),i=t-this._lastCallTime,e=this._interval;e<=i&&this._canRunImmediate?(this._lastCallTime=t,this._RunCallback()):this._timerId=self.setTimeout(this._timerCallFunc,Math.max(e-i,4))}}_RunCallback(){this._ignoreReset=!0,this._callback(),this._ignoreReset=!1}Reset(){this._ignoreReset||(this._CancelTimer(),this._lastCallTime=Date.now())}_OnTimer(){this._timerId=-1,this._lastCallTime=Date.now(),this._RunCallback()}_CancelTimer(){-1!==this._timerId&&(self.clearTimeout(this._timerId),this._timerId=-1)}Release(){this._CancelTimer(),this._callback=null,this._timerCallFunc=null}};

// workers/domElementHandler.js
"use strict";{class a{constructor(e){this._elem=e,this._hadFirstUpdate=!1,this._isVisibleFlag=!0,this._wantHtmlIndex=-1,this._actualHtmlIndex=-1,this._htmlZIndex=-1}SetVisibleFlag(e){this._isVisibleFlag=!!e}GetVisibleFlag(){return this._isVisibleFlag}HadFirstUpdate(){return this._hadFirstUpdate}SetHadFirstUpdate(){this._hadFirstUpdate=!0}GetWantHTMLIndex(){return this._wantHtmlIndex}SetWantHTMLIndex(e){this._wantHtmlIndex=e}GetActualHTMLIndex(){return this._actualHtmlIndex}SetActualHTMLIndex(e){this._actualHtmlIndex=e}SetHTMLZIndex(e){this._htmlZIndex=e}GetHTMLZIndex(){return this._htmlZIndex}GetElement(){return this._elem}}window.DOMElementHandler=class extends self.DOMHandler{constructor(e,t){super(e,t),this._elementMap=new Map,this._autoAttach=!0,this.AddRuntimeMessageHandlers([["create",e=>this._OnCreate(e)],["destroy",e=>this._OnDestroy(e)],["set-visible",e=>this._OnSetVisible(e)],["update-position",e=>this._OnUpdatePosition(e)],["update-state",e=>this._OnUpdateState(e)],["focus",e=>this._OnSetFocus(e)],["set-css-style",e=>this._OnSetCssStyle(e)],["set-attribute",e=>this._OnSetAttribute(e)],["remove-attribute",e=>this._OnRemoveAttribute(e)]]),this.AddDOMElementMessageHandler("get-element",e=>e)}SetAutoAttach(e){this._autoAttach=!!e}AddDOMElementMessageHandler(e,s){this.AddRuntimeMessageHandler(e,e=>{const t=e["elementId"],n=this.GetElementById(t);return s(n,e)})}AddDOMElementMessageHandlers(e){for(const[t,n]of e)this.AddDOMElementMessageHandler(t,n)}_OnCreate(e){const t=e["elementId"],n=this.CreateElement(t,e),s=new a(n),i=(this._elementMap.set(t,s),n.style.boxSizing="border-box",n.style.display="none",s.SetVisibleFlag(e["isVisible"]),this._GetFocusElement(n)),l=(i.addEventListener("focus",e=>this._OnFocus(t)),i.addEventListener("blur",e=>this._OnBlur(t)),e["htmlIndex"]);if(s.SetWantHTMLIndex(l),s.SetHTMLZIndex(e["htmlZIndex"]),this._autoAttach){const d=this.GetRuntimeInterface().GetAvailableHTMLIndex(l),r=(s.SetActualHTMLIndex(d),this.GetRuntimeInterface().GetHTMLWrapElement(d));r.appendChild(n)}}CreateElement(e,t){throw new Error("required override")}DestroyElement(e){}_OnDestroy(e){const t=e["elementId"],n=this.GetElementById(t);this.DestroyElement(n),this._autoAttach&&n.parentElement.removeChild(n),this._elementMap.delete(t)}PostToRuntimeElement(e,t,n){(n=n||{})["elementId"]=t,this.PostToRuntime(e,n)}_PostToRuntimeElementMaybeSync(e,t,n){(n=n||{})["elementId"]=t,this._PostToRuntimeMaybeSync(e,n)}_OnSetVisible(e){if(this._autoAttach){const t=this._elementMap.get(e["elementId"]),n=t.GetElement();t.HadFirstUpdate()?n.style.display=e["isVisible"]?"":"none":t.SetVisibleFlag(e["isVisible"])}}_OnUpdatePosition(e){if(this._autoAttach){const t=this._elementMap.get(e["elementId"]),n=t.GetElement(),s=this.GetRuntimeInterface(),i=(n.style.left=e["left"]+"px",n.style.top=e["top"]+"px",n.style.width=e["width"]+"px",n.style.height=e["height"]+"px",e["fontSize"]),l=(null!==i&&(n.style.fontSize=i+"em"),e["htmlIndex"]),a=(t.SetWantHTMLIndex(l),s.GetAvailableHTMLIndex(l));if(a!==t.GetActualHTMLIndex()){n.remove();const r=s.GetHTMLWrapElement(a);r.appendChild(n),t.SetActualHTMLIndex(a),s._UpdateHTMLElementsZOrder()}const d=e["htmlZIndex"];d!==t.GetHTMLZIndex()&&(t.SetHTMLZIndex(d),s._UpdateHTMLElementsZOrder()),t.HadFirstUpdate()||(t.SetHadFirstUpdate(),t.GetVisibleFlag()&&(n.style.display=""))}}_OnHTMLLayersChanged(){if(this._autoAttach)for(const e of this._elementMap.values()){const t=this.GetRuntimeInterface().GetAvailableHTMLIndex(e.GetWantHTMLIndex()),n=e.GetActualHTMLIndex();if(-1!==t&&-1!==n&&t!==n){const s=e.GetElement(),i=(s.remove(),this.GetRuntimeInterface().GetHTMLWrapElement(t));i.appendChild(s),e.SetActualHTMLIndex(t)}}}_GetAllElementStatesForZOrderUpdate(){return this._autoAttach?[...this._elementMap.values()]:null}_OnUpdateState(e){const t=this.GetElementById(e["elementId"]);this.UpdateState(t,e)}UpdateState(e,t){throw new Error("required override")}_GetFocusElement(e){return e}_OnFocus(e){this.PostToRuntimeElement("elem-focused",e)}_OnBlur(e){this.PostToRuntimeElement("elem-blurred",e)}_OnSetFocus(e){const t=this._GetFocusElement(this.GetElementById(e["elementId"]));e["focus"]?t.focus():t.blur()}_OnSetCssStyle(e){const t=this.GetElementById(e["elementId"]),n=e["prop"],s=e["val"];n.startsWith("--")?t.style.setProperty(n,s):t.style[n]=s}_OnSetAttribute(e){const t=this.GetElementById(e["elementId"]);t.setAttribute(e["name"],e["val"])}_OnRemoveAttribute(e){const t=this.GetElementById(e["elementId"]);t.removeAttribute(e["name"])}GetElementById(e){const t=this._elementMap.get(e);if(t)return t.GetElement();throw new Error("no element with id "+e)}}}

// workers/domSide.js
"use strict";{const a=/(iphone|ipod|ipad|macos|macintosh|mac os x)/i.test(navigator.userAgent),b=/android/i.test(navigator.userAgent),c=/safari/i.test(navigator.userAgent)&&!/(chrome|chromium|edg\/|OPR\/|nwjs)/i.test(navigator.userAgent);let d=0;function AddScript(s){const r=document.createElement("script");return r.async=!1,r.type="module",s.isStringSrc?new Promise(e=>{const t="c3_resolve_"+d;++d,self[t]=e,r.textContent=s.str+`

self["${t}"]();`,document.head.appendChild(r)}):new Promise((e,t)=>{r.onload=e,r.onerror=t,r.src=s,document.head.appendChild(r)})}async function CheckSupportsWorkerMode(){if(!navigator["userActivation"]||"undefined"==typeof OffscreenCanvas)return!1;try{let e=!1;const t=new Blob([`
	self.addEventListener("message", () =>
	{
		try {
			const offscreenCanvas = new OffscreenCanvas(32, 32);
			const gl = offscreenCanvas.getContext("webgl");
			self.postMessage(!!gl);
		}
		catch (err)
		{
			console.warn("Feature detection worker error:", err);
			self.postMessage(false);
		}
	});`],{"type":"text/javascript"}),s=new Worker(URL.createObjectURL(t),{get type(){e=!0}}),r=await new Promise(t=>{s.addEventListener("message",e=>{s.terminate(),t(e.data)}),s.postMessage("")});return e&&r}catch(e){return console.warn("Error feature detecting worker mode: ",e),!1}}let e=new Audio;const f={"audio/webm; codecs=opus":!!e.canPlayType("audio/webm; codecs=opus"),"audio/ogg; codecs=opus":!!e.canPlayType("audio/ogg; codecs=opus"),"audio/webm; codecs=vorbis":!!e.canPlayType("audio/webm; codecs=vorbis"),"audio/ogg; codecs=vorbis":!!e.canPlayType("audio/ogg; codecs=vorbis"),"audio/mp4":!!e.canPlayType("audio/mp4"),"audio/mpeg":!!e.canPlayType("audio/mpeg")};async function BlobToString(e){const t=await BlobToArrayBuffer(e),s=new TextDecoder("utf-8");return s.decode(t)}function BlobToArrayBuffer(r){return new Promise((t,s)=>{const e=new FileReader;e.onload=e=>t(e.target.result),e.onerror=e=>s(e),e.readAsArrayBuffer(r)})}e=null;const g=[];let r=0;const i=8,j=(window["RealFile"]=window["File"],[]),k=new Map,l=new Map;let h=0;const n=[],o=(self.runOnStartup=function(e){if("function"!=typeof e)throw new Error("runOnStartup called without a function");n.push(e)},new Set(["cordova","playable-ad-single-file","playable-ad-zip","instant-games"]));function IsWebViewExportType(e){return o.has(e)}let t=!1;window.RuntimeInterface=class Q{constructor(e){if(this._useWorker=e.useWorker,this._messageChannelPort=null,this._runtimeBaseUrl="",this._scriptFolder=e.scriptFolder,this._worker=null,this._localRuntime=null,this._domHandlers=[],this._runtimeDomHandler=null,this._isFirstSizeUpdate=!0,this._canvasLayers=[],this._pendingRemoveElements=[],this._pendingUpdateHTMLZOrder=!1,this._updateHTMLZOrderRAFCallback=()=>this._DoUpdateHTMLElementsZOrder(),this._isExportingToVideo=!1,this._exportToVideoDuration=0,this._jobScheduler=null,this._rafId=-1,this._rafFunc=()=>this._OnRAFCallback(),this._rafCallbacks=new Set,this._wrapperInitResolve=null,this._wrapperComponentIds=[],this._exportType=e.exportType,this._isFileProtocol="file"===location.protocol.substr(0,4),this._directoryHandles=[],"playable-ad-single-file"!==this._exportType&&"playable-ad-zip"!==this._exportType&&"instant-games"!==this._exportType||(this._useWorker=!1),c&&(this._useWorker=!1),"cordova"===this._exportType&&this._useWorker&&b){const t=/Chrome\/(\d+)/i.exec(navigator.userAgent);t&&90<=parseInt(t[1],10)||(this._useWorker=!1)}this.IsAnyWebView2Wrapper()?self["chrome"]["webview"].addEventListener("message",e=>this._OnWrapperMessage(e.data,e["additionalObjects"])):"macos-wkwebview"===this._exportType?self["C3WrapperOnMessage"]=e=>this._OnWrapperMessage(e):"linux-cef"===this._exportType&&self["c3_linux_cef_set_message_callback"](e=>this._OnWrapperMessage(JSON.parse(e))),this._localFileBlobs=null,this._localFileStrings=null,"html5"!==this._exportType||window.isSecureContext||console.warn("[Construct] Warning: the browser indicates this is not a secure context. Some features may be unavailable. Use secure (HTTPS) hosting to ensure all features are available."),this.AddRuntimeComponentMessageHandler("canvas","update-size",e=>this._OnUpdateCanvasSize(e)),this.AddRuntimeComponentMessageHandler("canvas","set-html-layer-count",e=>this["_OnSetHTMLLayerCount"](e)),this.AddRuntimeComponentMessageHandler("canvas","cleanup-html-layers",()=>this._OnCleanUpHTMLLayers()),this.AddRuntimeComponentMessageHandler("canvas","update-html-layer-dom-state",e=>this._UpdateHTMLLayerDOMProperties(e["layersDomState"])),this.AddRuntimeComponentMessageHandler("runtime","cordova-fetch-local-file",e=>this._OnCordovaFetchLocalFile(e)),this.AddRuntimeComponentMessageHandler("runtime","create-job-worker",e=>this._OnCreateJobWorker(e)),this.AddRuntimeComponentMessageHandler("runtime","send-wrapper-extension-message",e=>this._OnSendWrapperExtensionMessage(e)),"cordova"===this._exportType?document.addEventListener("deviceready",()=>this._Init(e)):this._Init(e),this._skipAndroidVirtualKeyboardDetection=0}Release(){this._CancelAnimationFrame(),this._messageChannelPort&&(this._messageChannelPort.onmessage=null,this._messageChannelPort=null),this._worker&&(this._worker.terminate(),this._worker=null),this._localRuntime&&(this._localRuntime.Release(),this._localRuntime=null);for(const{canvas:e,htmlWrap:t}of this._canvasLayers)e.remove(),t.remove();this._canvasLayers.length=0}GetMainCanvas(){return this._canvasLayers[0].canvas}GetAvailableHTMLIndex(e){return Math.min(e,this._canvasLayers.length-1)}GetHTMLWrapElement(e){if(e<0||e>=this._canvasLayers.length)throw new RangeError("invalid canvas layer");return this._canvasLayers[e].htmlWrap}["_GetHTMLWrapElement"](e){return this.GetHTMLWrapElement(e)}GetRuntimeBaseURL(){return this._runtimeBaseUrl}UsesWorker(){return this._useWorker}GetExportType(){return this._exportType}IsFileProtocol(){return this._isFileProtocol}GetScriptFolder(){return this._scriptFolder}IsiOSCordova(){return a&&"cordova"===this._exportType}IsiOSWebView(){const e=navigator.userAgent;return a&&IsWebViewExportType(this._exportType)||navigator["standalone"]||/crios\/|fxios\/|edgios\//i.test(e)}IsAndroid(){return b}IsAndroidWebView(){return b&&IsWebViewExportType(this._exportType)}IsWindowsWebView2(){return"windows-webview2"===this._exportType||!!("preview"===this._exportType&&window["chrome"]&&window["chrome"]["webview"]&&window["chrome"]["webview"]["postMessage"])}IsAnyWebView2Wrapper(){return this.IsWindowsWebView2()||"xbox-uwp-webview2"===this._exportType}SkipNextAndroidVirtualKeyboardDetection(){this.IsAndroidWebView()&&this._skipAndroidVirtualKeyboardDetection++}CanDoAndroidVirtualKeyboardDetection(){return this._CanDoAndroidVirtualKeyboardDetection().next().value}*_CanDoAndroidVirtualKeyboardDetection(){if(!this.IsAndroidWebView())return!0;yield 0===this._skipAndroidVirtualKeyboardDetection,0<this._skipAndroidVirtualKeyboardDetection&&this._skipAndroidVirtualKeyboardDetection--}async _Init(e){if(this._useWorker){const s=await CheckSupportsWorkerMode();s||(this._useWorker=!1)}if("macos-wkwebview"===this._exportType)this._SendWrapperMessage({"type":"ready"});else if(this.IsAnyWebView2Wrapper()||"linux-cef"===this._exportType){this._SetupDesktopWrapperPolyfills();const r=await this._InitWrapper();this._wrapperComponentIds=r["registeredComponentIds"]}if("playable-ad-single-file"===this._exportType&&(this._localFileBlobs=self["c3_base64files"],this._localFileStrings={},await this._ConvertDataUrisToBlobs()),"nwjs"===this._exportType&&self["nw"]){const i=self["nw"]["Window"]["get"]();if(i["on"]("close",()=>self["nw"]["App"]["quit"]()),self["nw"]["App"]["manifest"]["c3-steam-mode"]){let e=0;this._AddRAFCallback(()=>{e++,document.documentElement.style.opacity=e%2==0?"1":"0.999"})}}if(e.runtimeBaseUrl)this._runtimeBaseUrl=e.runtimeBaseUrl;else{const n=location.origin,a=(this._runtimeBaseUrl=("null"===n?"file:///":n)+location.pathname,this._runtimeBaseUrl.lastIndexOf("/"));-1!==a&&(this._runtimeBaseUrl=this._runtimeBaseUrl.substr(0,a+1))}const t=new MessageChannel;if(this._messageChannelPort=t.port1,this._messageChannelPort.onmessage=e=>this["_OnMessageFromRuntime"](e.data),window["c3_addPortMessageHandler"]&&window["c3_addPortMessageHandler"](e=>this._OnMessageFromDebugger(e)),this._jobScheduler=new self.JobSchedulerDOM(this),await this._jobScheduler.Init(),"object"==typeof window["StatusBar"]&&window["StatusBar"]["hide"](),"object"==typeof window["AndroidFullScreen"])try{await new Promise((e,t)=>{window["AndroidFullScreen"]["immersiveMode"](e,t)})}catch(e){console.error("Failed to enter Android immersive mode: ",e)}this._useWorker?await this._InitWorker(e,t.port2):await this._InitDOM(e,t.port2)}_GetCommonRuntimeOptions(e){return{"runtimeBaseUrl":this._runtimeBaseUrl,"previewUrl":location.href,"windowInnerWidth":this._GetWindowInnerWidth(),"windowInnerHeight":this._GetWindowInnerHeight(),"cssDisplayMode":this.GetCssDisplayMode(),"devicePixelRatio":window.devicePixelRatio,"isFullscreen":Q.IsDocumentFullscreen(),"swClientId":window["cr_swClientId"]||"","exportType":e.exportType,"isNWjs":"undefined"!=typeof nw,"fileMap":globalThis.c3_swFileMap??new Map(Object.entries(this._localFileBlobs??{})),"scriptFolder":this._scriptFolder,"isDebug":new URLSearchParams(self.location.search).has("debug"),"ife":!!self.ife,"jobScheduler":this._jobScheduler.GetPortData(),"supportedAudioFormats":f,"isFileProtocol":this._isFileProtocol,"isiOSCordova":this.IsiOSCordova(),"isiOSWebView":this.IsiOSWebView(),"isWindowsWebView2":this.IsWindowsWebView2(),"isAnyWebView2Wrapper":this.IsAnyWebView2Wrapper(),"wrapperComponentIds":this._wrapperComponentIds,"isFBInstantAvailable":void 0!==self["FBInstant"]}}async _InitWorker(e,t){const i=e.workerMainUrl,s=("preview"===this._exportType?(this._worker=new Worker("previewworker.js",{type:"module",name:"Runtime"}),await new Promise((t,s)=>{const r=e=>{this._worker.removeEventListener("message",r),(e.data&&"ok"===e.data["type"]?t:s)()};this._worker.addEventListener("message",r),this._worker.postMessage({"type":"construct-worker-init","import":new URL(i,this._runtimeBaseUrl).toString()})})):this._worker=await this.CreateWorker(i,{type:"module",name:"Runtime"}),document.createElement("canvas")),r=(s.style.display="none",s["transferControlToOffscreen"]()),n=(document.body.appendChild(s),document.createElement("div"));n.className="c3htmlwrap",n.setAttribute("interactive",""),document.body.appendChild(n),this._canvasLayers.push({canvas:s,htmlWrap:n,lastHtmlLayerDomState:{isVisible:!0,opacity:1,isInteractive:!0}}),window["c3canvas"]=s,self["C3_InsertHTMLPlaceholders"]&&self["C3_InsertHTMLPlaceholders"](),this._worker.postMessage(Object.assign(this._GetCommonRuntimeOptions(e),{"type":"init-runtime","isInWorker":!0,"messagePort":t,"canvas":r,"runtimeScriptList":e.runtimeScriptList,"projectMainScriptPath":e.projectMainScriptPath,"scriptsInEventsPath":e.scriptsInEventsPath}),[t,r,...this._jobScheduler.GetPortTransferables()]),this._domHandlers=j.map(e=>new e(this)),this._FindRuntimeDOMHandler(),this._runtimeDomHandler._AddDefaultCanvasEventHandlers(s),this._runtimeDomHandler._AddDefaultHTMLWrapEventHandlers(n),this._runtimeDomHandler._EnableWindowResizeEvent(),self["c3_callFunction"]=(e,t)=>this._runtimeDomHandler._InvokeFunctionFromJS(e,t),"preview"===this._exportType&&(self["goToLastErrorScript"]=()=>this.PostToRuntimeComponent("runtime","go-to-last-error-script"))}async _InitDOM(e,t){const s=document.createElement("canvas"),r=(s.style.display="none",document.body.appendChild(s),document.createElement("div")),i=(r.className="c3htmlwrap",r.setAttribute("interactive",""),document.body.appendChild(r),this._canvasLayers.push({canvas:s,htmlWrap:r,lastHtmlLayerDomState:{isVisible:!0,opacity:1,isInteractive:!0}}),window["c3canvas"]=s,self["C3_InsertHTMLPlaceholders"]&&self["C3_InsertHTMLPlaceholders"](),this._domHandlers=j.map(e=>new e(this)),this._FindRuntimeDOMHandler(),this._runtimeDomHandler._AddDefaultCanvasEventHandlers(s),this._runtimeDomHandler._AddDefaultHTMLWrapEventHandlers(r),await Promise.all(e.runtimeScriptList.map(e=>this._MaybeGetPlatformSpecificScriptURL(e)))),a=(await Promise.all(i.map(e=>AddScript(e))),e.projectMainScriptPath),o=e.scriptsInEventsPath;if(a)try{if(await AddScript(a),"preview"===this._exportType&&!globalThis.C3_ProjectMainScriptOK)throw new Error("main script did not run to completion")}catch(e){this._RemoveLoadingMessage(),console.error("Error loading project main script: ",e),alert(`Failed to load the project main script (${a}). Check all your JavaScript code has valid syntax, all imports are written correctly, and that an exception was not thrown running the script. Press F12 and check the console for error details.`)}if(o)try{if(await AddScript(o),"preview"===this._exportType&&!globalThis.C3.ScriptsInEvents)throw new Error("scripts in events did not run to completion")}catch(e){this._RemoveLoadingMessage(),console.error("Error loading scripts in events: ",e),alert("Failed to load scripts in events. Check all your JavaScript code has valid syntax, all imports are written correctly, and that an exception was not thrown running the 'Imports for events' script. Press F12 and check the console for error details.")}const l=Object.assign(this._GetCommonRuntimeOptions(e),{"isInWorker":!1,"messagePort":t,"canvas":s,"runOnStartupFunctions":n});this._runtimeDomHandler._EnableWindowResizeEvent(),this._OnBeforeCreateRuntime(),this._localRuntime=self["C3_CreateRuntime"](l),await self["C3_InitRuntime"](this._localRuntime,l)}async CreateWorker(e,t){if(e.startsWith("blob:"))return new Worker(e,t);if("cordova"===this._exportType&&this._isFileProtocol){const i=await this.CordovaFetchLocalFileAsArrayBuffer(e),n=new Blob([i],{type:"application/javascript"});return new Worker(URL.createObjectURL(n),t)}if("playable-ad-single-file"===this._exportType){const a=this._localFileBlobs[e];if(a)return new Worker(URL.createObjectURL(a),t);throw new Error("missing script: "+e)}const s=new URL(e,location.href),r=location.origin!==s.origin;if(r){const o=await fetch(s);if(!o.ok)throw new Error("failed to fetch worker script");const l=await o.blob();return new Worker(URL.createObjectURL(l),t)}return new Worker(s,t)}_GetWindowInnerWidth(){return Math.max(window.innerWidth,1)}_GetWindowInnerHeight(){return Math.max(window.innerHeight,1)}GetCssDisplayMode(){if(this.IsAnyWebView2Wrapper())return"standalone";const e=this.GetExportType(),t=new Set(["cordova","nwjs","macos-wkwebview","linux-cef"]);return t.has(e)?"standalone":window.matchMedia("(display-mode: fullscreen)").matches?"fullscreen":window.matchMedia("(display-mode: standalone)").matches?"standalone":window.matchMedia("(display-mode: minimal-ui)").matches?"minimal-ui":navigator["standalone"]?"standalone":"browser"}_OnBeforeCreateRuntime(){this._RemoveLoadingMessage()}_RemoveLoadingMessage(){const e=window["cr_previewLoadingElem"];e&&(e.parentElement.removeChild(e),window["cr_previewLoadingElem"]=null)}async _OnCreateJobWorker(e){const t=await this._jobScheduler._CreateJobWorker();return{"outputPort":t,"transferables":[t]}}_OnUpdateCanvasSize(e){if(!this.IsExportingToVideo()){const t=e["styleWidth"]+"px",s=e["styleHeight"]+"px",r=e["marginLeft"]+"px",i=e["marginTop"]+"px";for(const{canvas:n,htmlWrap:a}of this._canvasLayers)n.style.width=t,n.style.height=s,n.style.marginLeft=r,n.style.marginTop=i,a.style.width=t,a.style.height=s,a.style.marginLeft=r,a.style.marginTop=i,this._isFirstSizeUpdate&&(n.style.display="",a.style.display="");document.documentElement.style.setProperty("--construct-scale",e["displayScale"]),this._isFirstSizeUpdate=!1}}["_OnSetHTMLLayerCount"](e){const s=e["count"],t=e["layersDomState"],r=e["immediate"],i=e["styleWidth"]+"px",n=e["styleHeight"]+"px",a=e["marginLeft"]+"px",o=e["marginTop"]+"px",l=[],c=[];if(s<this._canvasLayers.length)for(;this._canvasLayers.length>s;){const{canvas:d,htmlWrap:h}=this._canvasLayers.pop();h.remove(),this._useWorker&&!r?this._pendingRemoveElements.push(d):d.remove()}else if(s>this._canvasLayers.length)for(let e=0,t=s-this._canvasLayers.length;e<t;++e){const p=document.createElement("canvas");if(p.classList.add("c3overlay"),this._useWorker){const u=p["transferControlToOffscreen"]();l.push(u),c.push(u)}else l.push(p);document.body.appendChild(p);const m=document.createElement("div");m.classList.add("c3htmlwrap","c3overlay"),m.setAttribute("interactive",""),document.body.appendChild(m),p.style.width=i,p.style.height=n,p.style.marginLeft=a,p.style.marginTop=o,m.style.width=i,m.style.height=n,m.style.marginLeft=a,m.style.marginTop=o,this._runtimeDomHandler._AddDefaultCanvasEventHandlers(p),this._runtimeDomHandler._AddDefaultHTMLWrapEventHandlers(m),this._canvasLayers.push({canvas:p,htmlWrap:m,lastHtmlLayerDomState:{isVisible:!0,opacity:1,isInteractive:!0}})}this._UpdateHTMLLayerDOMProperties(t);for(const _ of this._domHandlers)_ instanceof window.DOMElementHandler&&_._OnHTMLLayersChanged();return this._UpdateHTMLElementsZOrder(),{"addedCanvases":l,"transferables":c}}_UpdateHTMLLayerDOMProperties(s){for(let e=0,t=Math.min(this._canvasLayers.length,s.length);e<t;++e){const{htmlWrap:r,lastHtmlLayerDomState:i}=this._canvasLayers[e],n=s[e],a=n["isVisible"],o=n["opacity"],l=n["isInteractive"];a!==i.isVisible&&(r.style.display=a?"":"none",i.isVisible=a),o!==i.opacity&&(r.style.opacity=1===o?"":String(o),i.opacity=o),l!==i.isInteractive&&(r.style.pointerEvents=l?"":"none",l?r.setAttribute("interactive",""):r.removeAttribute("interactive"),i.isInteractive=l)}}_OnCleanUpHTMLLayers(){for(const e of this._pendingRemoveElements)e.remove();this._pendingRemoveElements.length=0}_UpdateHTMLElementsZOrder(){this._pendingUpdateHTMLZOrder||(this._pendingUpdateHTMLZOrder=!0,this._AddRAFCallback(this._updateHTMLZOrderRAFCallback))}_DoUpdateHTMLElementsZOrder(){this._RemoveRAFCallback(this._updateHTMLZOrderRAFCallback),this._pendingUpdateHTMLZOrder=!1;let e=[];for(const n of this._domHandlers)if(n instanceof window.DOMElementHandler){const a=n._GetAllElementStatesForZOrderUpdate();a&&e.push(...a)}e.sort((e,t)=>{const s=e.GetActualHTMLIndex(),r=t.GetActualHTMLIndex();if(s!==r)return s-r;const i=e.GetHTMLZIndex(),n=t.GetHTMLZIndex();return i-n});let t=0,s=0,r=0,i=e.length;for(;r<i;++r){const o=e[r];o.GetActualHTMLIndex()!==t&&(this._DoUpdateHTMLElementsZOrderOnHTMLLayer(t,e.slice(s,r)),t=o.GetActualHTMLIndex(),s=r)}s<r&&this._DoUpdateHTMLElementsZOrderOnHTMLLayer(t,e.slice(s,r))}_DoUpdateHTMLElementsZOrderOnHTMLLayer(e,t){if(!(t.length<=1||e>=this._canvasLayers.length)){const r=t.map(e=>e.GetElement()),s=new Set(r),i=this.GetHTMLWrapElement(e),n=Array.from(i.children).filter(e=>s.has(e));for(let e=0,t=0,s=r.length;e<s;++e){const a=r[e],o=n[t];a===o?++t:i.insertBefore(a,o)}}}_GetLocalRuntime(){if(this._useWorker)throw new Error("not available in worker mode");return this._localRuntime}PostToRuntimeComponent(e,t,s,r,i){this._messageChannelPort.postMessage({"type":"event","component":e,"handler":t,"dispatchOpts":r||null,"data":s,"responseId":null},i)}PostToRuntimeComponentAsync(e,t,s,r,i){const n=h++,a=new Promise((e,t)=>{l.set(n,{resolve:e,reject:t})});return this._messageChannelPort.postMessage({"type":"event","component":e,"handler":t,"dispatchOpts":r||null,"data":s,"responseId":n},i),a}["_OnMessageFromRuntime"](e){const t=e["type"];if("event"===t)return this._OnEventFromRuntime(e);if("result"===t)this._OnResultFromRuntime(e);else if("runtime-ready"===t)this._OnRuntimeReady();else if("alert-error"===t)this._RemoveLoadingMessage(),alert(e["message"]);else{if("creating-runtime"!==t)throw new Error(`unknown message '${t}'`);this._OnBeforeCreateRuntime()}}_OnEventFromRuntime(e){const t=e["component"],s=e["handler"],r=e["data"],i=e["responseId"],n=k.get(t);if(n){const a=n.get(s);if(a){let e=null;try{e=a(r)}catch(e){return console.error(`Exception in '${t}' handler '${s}':`,e),void(null!==i&&this._PostResultToRuntime(i,!1,""+e))}if(null===i)return e;e&&e.then?e.then(e=>this._PostResultToRuntime(i,!0,e)).catch(e=>{console.error(`Rejection from '${t}' handler '${s}':`,e),this._PostResultToRuntime(i,!1,""+e)}):this._PostResultToRuntime(i,!0,e)}else console.warn(`[DOM] No handler '${s}' for component '${t}'`)}else console.warn(`[DOM] No event handlers for component '${t}'`)}_PostResultToRuntime(e,t,s){let r;s&&s["transferables"]&&(r=s["transferables"]),this._messageChannelPort.postMessage({"type":"result","responseId":e,"isOk":t,"result":s},r)}_OnResultFromRuntime(e){const t=e["responseId"],s=e["isOk"],r=e["result"],i=l.get(t);s?i.resolve(r):i.reject(r),l.delete(t)}AddRuntimeComponentMessageHandler(e,t,s){let r=k.get(e);if(r||(r=new Map,k.set(e,r)),r.has(t))throw new Error(`[DOM] Component '${e}' already has handler '${t}'`);r.set(t,s)}static AddDOMHandlerClass(e){if(j.includes(e))throw new Error("DOM handler already added");j.push(e)}_FindRuntimeDOMHandler(){for(const e of this._domHandlers)if("runtime"===e.GetComponentID())return void(this._runtimeDomHandler=e);throw new Error("cannot find runtime DOM handler")}_OnMessageFromDebugger(e){this.PostToRuntimeComponent("debugger","message",e)}_OnRuntimeReady(){for(const e of this._domHandlers)e.Attach()}static IsDocumentFullscreen(){return!!(document["fullscreenElement"]||document["webkitFullscreenElement"]||document["mozFullScreenElement"]||t)}static _SetWrapperIsFullscreenFlag(e){t=!!e}async GetRemotePreviewStatusInfo(){return this.PostToRuntimeComponentAsync("runtime","get-remote-preview-status-info")}_AddRAFCallback(e){this._rafCallbacks.add(e),this._RequestAnimationFrame()}_RemoveRAFCallback(e){this._rafCallbacks.delete(e),0===this._rafCallbacks.size&&this._CancelAnimationFrame()}_RequestAnimationFrame(){-1===this._rafId&&0<this._rafCallbacks.size&&(this._rafId=requestAnimationFrame(this._rafFunc))}_CancelAnimationFrame(){-1!==this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=-1)}_OnRAFCallback(){this._rafId=-1;for(const e of this._rafCallbacks)e();this._RequestAnimationFrame()}TryPlayMedia(e){this._runtimeDomHandler.TryPlayMedia(e)}RemovePendingPlay(e){this._runtimeDomHandler.RemovePendingPlay(e)}_PlayPendingMedia(){this._runtimeDomHandler._PlayPendingMedia()}SetSilent(e){this._runtimeDomHandler.SetSilent(e)}IsAudioFormatSupported(e){return!!f[e]}async _WasmDecodeWebMOpus(e){const t=await this.PostToRuntimeComponentAsync("runtime","opus-decode",{"arrayBuffer":e},null,[e]);return new Float32Array(t)}SetIsExportingToVideo(e){this._isExportingToVideo=!0,this._exportToVideoDuration=e}IsExportingToVideo(){return this._isExportingToVideo}GetExportToVideoDuration(){return this._exportToVideoDuration}IsAbsoluteURL(e){return/^(?:[a-z\-]+:)?\/\//.test(e)||"data:"===e.substr(0,5)||"blob:"===e.substr(0,5)}IsRelativeURL(e){return!this.IsAbsoluteURL(e)}async _MaybeGetPlatformSpecificScriptURL(t){if("cordova"===this._exportType&&(t.startsWith("file:")||this._isFileProtocol&&this.IsRelativeURL(t))){let e=t;e.startsWith(this._runtimeBaseUrl)&&(e=e.substr(this._runtimeBaseUrl.length));const s=await this.CordovaFetchLocalFileAsArrayBuffer(e),r=new Blob([s],{type:"application/javascript"});return URL.createObjectURL(r)}if("playable-ad-single-file"!==this._exportType)return t;if(this._localFileStrings.hasOwnProperty(t))return{isStringSrc:!0,str:this._localFileStrings[t]};if(this._localFileBlobs.hasOwnProperty(t))return URL.createObjectURL(this._localFileBlobs[t]);throw new Error("missing script: "+t)}async _OnCordovaFetchLocalFile(e){const t=e["filename"];switch(e["as"]){case"text":return this.CordovaFetchLocalFileAsText(t);case"buffer":return this.CordovaFetchLocalFileAsArrayBuffer(t);default:throw new Error("unsupported type")}}CordovaFetchLocalFile(e){const r=window["cordova"]["file"]["applicationDirectory"]+"www/"+e;return new Promise((t,s)=>{window["resolveLocalFileSystemURL"](r,e=>{e["file"](t,s)},s)})}async CordovaFetchLocalFileAsText(e){const t=await this.CordovaFetchLocalFile(e);return BlobToString(t)}_CordovaMaybeStartNextArrayBufferRead(){if(g.length&&!(r>=i)){r++;const e=g.shift();this._CordovaDoFetchLocalFileAsAsArrayBuffer(e.filename,e.successCallback,e.errorCallback)}}CordovaFetchLocalFileAsArrayBuffer(e){return new Promise((t,s)=>{g.push({filename:e,successCallback:e=>{r--,this._CordovaMaybeStartNextArrayBufferRead(),t(e)},errorCallback:e=>{r--,this._CordovaMaybeStartNextArrayBufferRead(),s(e)}}),this._CordovaMaybeStartNextArrayBufferRead()})}async _CordovaDoFetchLocalFileAsAsArrayBuffer(e,t,s){try{const r=await this.CordovaFetchLocalFile(e),i=await BlobToArrayBuffer(r);t(i)}catch(e){s(e)}}["_PlayableAdFetchBlob"](e){if(this._localFileBlobs.hasOwnProperty(e))return this._localFileBlobs[e];throw new Error("missing file: "+e)}_GetPermissionAPI(){const e=window["cordova"]&&window["cordova"]["plugins"]&&window["cordova"]["plugins"]["permissions"];if("object"!=typeof e)throw new Error("Permission API is not loaded");return e}_MapPermissionID(e,t){const s=e[t];if("string"!=typeof s)throw new Error("Invalid permission name");return s}_HasPermission(s){const r=this._GetPermissionAPI();return new Promise((t,e)=>r["checkPermission"](this._MapPermissionID(r,s),e=>t(!!e["hasPermission"]),e))}_RequestPermission(s){const r=this._GetPermissionAPI();return new Promise((t,e)=>r["requestPermission"](this._MapPermissionID(r,s),e=>t(!!e["hasPermission"]),e))}async RequestPermissions(e){if("cordova"===this.GetExportType()&&!this.IsiOSCordova())for(const t of e){const s=await this._HasPermission(t);if(!s){const r=await this._RequestPermission(t);if(!1===r)return!1}}return!0}async RequirePermissions(...e){if(!1===await this.RequestPermissions(e))throw new Error("Permission not granted")}_OnWrapperMessage(e,t){if("entered-fullscreen"===e)Q._SetWrapperIsFullscreenFlag(!0),this._runtimeDomHandler._OnFullscreenChange();else if("exited-fullscreen"===e)Q._SetWrapperIsFullscreenFlag(!1),this._runtimeDomHandler._OnFullscreenChange();else if("object"==typeof e){const s=e["type"];"directory-handles"===s?this._directoryHandles=t:"wrapper-init-response"===s?(this._wrapperInitResolve(e),this._wrapperInitResolve=null):"extension-message"===s?this.PostToRuntimeComponent("runtime","wrapper-extension-message",e):console.warn("Unknown wrapper message: ",e)}else console.warn("Unknown wrapper message: ",e)}_OnSendWrapperExtensionMessage(e){this._SendWrapperMessage({"type":"extension-message","componentId":e["componentId"],"messageId":e["messageId"],"params":e["params"]||[],"asyncId":e["asyncId"]})}_SendWrapperMessage(e){this.IsAnyWebView2Wrapper()?window["chrome"]["webview"]["postMessage"](JSON.stringify(e)):"macos-wkwebview"===this._exportType?window["webkit"]["messageHandlers"]["C3Wrapper"]["postMessage"](JSON.stringify(e)):"linux-cef"===this._exportType&&window["c3_linux_cef_sendmessage"](JSON.stringify(e))}_SetupDesktopWrapperPolyfills(){window.moveTo=(e,t)=>{this._SendWrapperMessage({"type":"set-window-position","windowX":Math.ceil(e),"windowY":Math.ceil(t)})},window.resizeTo=(e,t)=>{this._SendWrapperMessage({"type":"set-window-size","windowWidth":Math.ceil(e),"windowHeight":Math.ceil(t)})}}_InitWrapper(){return new Promise(e=>{this._wrapperInitResolve=e,this._SendWrapperMessage({"type":"wrapper-init"})})}_GetDirectoryHandles(){return this._directoryHandles}async _ConvertDataUrisToBlobs(){const e=[];for(const[t,s]of Object.entries(this._localFileBlobs))e.push(this._ConvertDataUriToBlobs(t,s));await Promise.all(e)}async _ConvertDataUriToBlobs(t,s){if("object"==typeof s)this._localFileBlobs[t]=new Blob([s["str"]],{"type":s["type"]}),this._localFileStrings[t]=s["str"];else{let e=await this._FetchDataUri(s);e=e||this._DataURIToBinaryBlobSync(s),this._localFileBlobs[t]=e}}async _FetchDataUri(e){try{const t=await fetch(e);return await t.blob()}catch(e){return console.warn("Failed to fetch a data: URI. Falling back to a slower workaround. This is probably because the Content Security Policy unnecessarily blocked it. Allow data: URIs in your CSP to avoid this.",e),null}}_DataURIToBinaryBlobSync(e){const t=this._ParseDataURI(e);return this._BinaryStringToBlob(t.data,t.mime_type)}_ParseDataURI(e){const t=e.indexOf(",");if(t<0)throw new URIError("expected comma in data: uri");const s=e.substring(5,t),r=e.substring(t+1),i=s.split(";"),n=i[0]||"",a=i[1],o=i[2];let l;return{mime_type:n,data:l=("base64"===a||"base64"===o?atob:decodeURIComponent)(r)}}_BinaryStringToBlob(e,t){let s=e.length,r=s>>2,i=new Uint8Array(s),n=new Uint32Array(i.buffer,0,r),a,o;for(a=0,o=0;a<r;++a)n[a]=e.charCodeAt(o++)|e.charCodeAt(o++)<<8|e.charCodeAt(o++)<<16|e.charCodeAt(o++)<<24;let l=3&s;for(;l--;)i[o]=e.charCodeAt(o),++o;return new Blob([i],{"type":t})}}}

// workers/runtimeDomEvents.js
"use strict";{const a=self.RuntimeInterface;function IsCompatibilityMouseEvent(e){return e["sourceCapabilities"]&&e["sourceCapabilities"]["firesTouchEvents"]||e["originalEvent"]&&e["originalEvent"]["sourceCapabilities"]&&e["originalEvent"]["sourceCapabilities"]["firesTouchEvents"]}const b=new Map([["OSLeft","MetaLeft"],["OSRight","MetaRight"]]),c={"dispatchRuntimeEvent":!0,"dispatchUserScriptEvent":!0},d={"dispatchUserScriptEvent":!0},e={"dispatchRuntimeEvent":!0};function AddStyleSheet(i){return new Promise((e,t)=>{const n=document.createElement("link");n.onload=()=>e(n),n.onerror=e=>t(e),n.rel="stylesheet",n.href=i,document.head.appendChild(n)})}function FetchImage(i){return new Promise((e,t)=>{const n=new Image;n.onload=()=>e(n),n.onerror=e=>t(e),n.src=i})}async function BlobToImage(e){const t=URL.createObjectURL(e);try{return await FetchImage(t)}finally{URL.revokeObjectURL(t)}}function BlobToString(i){return new Promise((t,n)=>{let e=new FileReader;e.onload=e=>t(e.target.result),e.onerror=e=>n(e),e.readAsText(i)})}function IsInContentEditable(e){do{if(e.parentNode&&e.hasAttribute("contenteditable"))return!0}while(e=e.parentNode);return!1}const f=new Set(["input","textarea","datalist","select"]);function IsKeyboardInputElement(e){return f.has(e.tagName.toLowerCase())||IsInContentEditable(e)}const g=new Set(["canvas","body","html"]);function PreventDefaultOnCanvasOrDoc(e){if(e.target.tagName){const t=e.target.tagName.toLowerCase();g.has(t)&&e.preventDefault()}}function PreventDefaultOnHTMLWrap(e){e.target.tagName&&e.target.classList.contains("c3htmlwrap")&&e.preventDefault()}function BlockWheelZoom(e){(e.metaKey||e.ctrlKey)&&e.preventDefault()}self["C3_GetSvgImageSize"]=async function(e){const t=await BlobToImage(e);if(0<t.width&&0<t.height)return[t.width,t.height];{t.style.position="absolute",t.style.left="0px",t.style.top="0px",t.style.visibility="hidden",document.body.appendChild(t);const n=t.getBoundingClientRect();return document.body.removeChild(t),[n.width,n.height]}};let t=!(self["C3_RasterSvgImageBlob"]=async function(e,t,n,i,o){const s=await BlobToImage(e),a=document.createElement("canvas"),r=(a.width=i,a.height=o,a.getContext("2d"));return r.drawImage(s,0,0,t,n),a});function ParentHasFocus(){try{return window.parent&&window.parent.document.hasFocus()}catch(e){return!1}}document.addEventListener("pause",()=>t=!0),document.addEventListener("resume",()=>t=!1);const i="runtime",j=class extends self.DOMHandler{constructor(e){super(e,i),this._enableWindowResizeEvent=!1,this._simulatedResizeTimerId=-1,this._targetOrientation="any",this._attachedDeviceOrientationEvent=!1,this._attachedDeviceMotionEvent=!1,this._pageVisibilityIsHidden=!1,this._screenReaderTextWrap=document.createElement("div"),this._screenReaderTextWrap.className="c3-screen-reader-text",this._screenReaderTextWrap.setAttribute("aria-live","polite"),document.body.appendChild(this._screenReaderTextWrap),this._debugHighlightElem=null,this._isExportToVideo=!1,this._exportVideoProgressMessage="",this._exportVideoUpdateTimerId=-1,this._enableAndroidVKDetection=!1,this._lastWindowWidth=e._GetWindowInnerWidth(),this._lastWindowHeight=e._GetWindowInnerHeight(),this._virtualKeyboardHeight=0,this._vkTranslateYOffset=0,e.AddRuntimeComponentMessageHandler("runtime","invoke-download",e=>this._OnInvokeDownload(e)),e.AddRuntimeComponentMessageHandler("runtime","load-webfonts",e=>this._OnLoadWebFonts(e)),e.AddRuntimeComponentMessageHandler("runtime","raster-svg-image",e=>this._OnRasterSvgImage(e)),e.AddRuntimeComponentMessageHandler("runtime","get-svg-image-size",e=>this._OnGetSvgImageSize(e)),e.AddRuntimeComponentMessageHandler("runtime","set-target-orientation",e=>this._OnSetTargetOrientation(e)),e.AddRuntimeComponentMessageHandler("runtime","register-sw",()=>this._OnRegisterSW()),e.AddRuntimeComponentMessageHandler("runtime","post-to-debugger",e=>this._OnPostToDebugger(e)),e.AddRuntimeComponentMessageHandler("runtime","go-to-script",e=>this._OnPostToDebugger(e)),e.AddRuntimeComponentMessageHandler("runtime","before-start-ticking",()=>this._OnBeforeStartTicking()),e.AddRuntimeComponentMessageHandler("runtime","debug-highlight",e=>this._OnDebugHighlight(e)),e.AddRuntimeComponentMessageHandler("runtime","enable-device-orientation",()=>this._AttachDeviceOrientationEvent()),e.AddRuntimeComponentMessageHandler("runtime","enable-device-motion",()=>this._AttachDeviceMotionEvent()),e.AddRuntimeComponentMessageHandler("runtime","add-stylesheet",e=>this._OnAddStylesheet(e)),e.AddRuntimeComponentMessageHandler("runtime","script-create-worker",e=>this._OnScriptCreateWorker(e)),e.AddRuntimeComponentMessageHandler("runtime","alert",e=>this._OnAlert(e)),e.AddRuntimeComponentMessageHandler("runtime","screen-reader-text",e=>this._OnScreenReaderTextEvent(e)),e.AddRuntimeComponentMessageHandler("runtime","hide-cordova-splash",()=>this._OnHideCordovaSplash()),e.AddRuntimeComponentMessageHandler("runtime","set-exporting-to-video",e=>this._SetExportingToVideo(e)),e.AddRuntimeComponentMessageHandler("runtime","export-to-video-progress",e=>this._OnExportVideoProgress(e)),e.AddRuntimeComponentMessageHandler("runtime","exported-to-video",e=>this._OnExportedToVideo(e)),e.AddRuntimeComponentMessageHandler("runtime","exported-to-image-sequence",e=>this._OnExportedToImageSequence(e));const o=new Set(["input","textarea","datalist"]);if(window.addEventListener("contextmenu",e=>{const t=e.target,n=t.tagName.toLowerCase();o.has(n)||IsInContentEditable(t)||e.preventDefault()}),window.addEventListener("selectstart",PreventDefaultOnCanvasOrDoc),window.addEventListener("gesturehold",PreventDefaultOnCanvasOrDoc),window.addEventListener("touchstart",PreventDefaultOnCanvasOrDoc,{"passive":!1}),window.addEventListener("pointerdown",PreventDefaultOnCanvasOrDoc,{"passive":!1}),this._mousePointerLastButtons=0,window.addEventListener("mousedown",e=>{1===e.button&&e.preventDefault()}),window.addEventListener("mousewheel",BlockWheelZoom,{"passive":!1}),window.addEventListener("wheel",BlockWheelZoom,{"passive":!1}),window.addEventListener("resize",()=>this._OnWindowResize()),window.addEventListener("fullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("webkitfullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("mozfullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("fullscreenerror",e=>this._OnFullscreenError(e)),window.addEventListener("webkitfullscreenerror",e=>this._OnFullscreenError(e)),window.addEventListener("mozfullscreenerror",e=>this._OnFullscreenError(e)),e.IsiOSWebView()){let t=1/0;window["visualViewport"].addEventListener("resize",()=>{const e=window["visualViewport"].height;e>t&&(document.scrollingElement.scrollTop=0,document.scrollingElement.scrollLeft=0),t=e}),document.documentElement.setAttribute("ioswebview","")}this._mediaPendingPlay=new Set,this._mediaRemovedPendingPlay=new WeakSet,this._isSilent=!1}_AddDefaultCanvasEventHandlers(e){e.addEventListener("selectstart",PreventDefaultOnCanvasOrDoc),e.addEventListener("gesturehold",PreventDefaultOnCanvasOrDoc),e.addEventListener("pointerdown",PreventDefaultOnCanvasOrDoc)}_AddDefaultHTMLWrapEventHandlers(e){e.addEventListener("selectstart",PreventDefaultOnHTMLWrap),e.addEventListener("gesturehold",PreventDefaultOnHTMLWrap),e.addEventListener("touchstart",PreventDefaultOnHTMLWrap)}_OnBeforeStartTicking(){return self.setTimeout(()=>{this._enableAndroidVKDetection=!0},1e3),"cordova"===this._iRuntime.GetExportType()?(document.addEventListener("pause",()=>this._OnVisibilityChange(!0)),document.addEventListener("resume",()=>this._OnVisibilityChange(!1))):document.addEventListener("visibilitychange",()=>this._OnVisibilityChange("hidden"===document.visibilityState)),this._pageVisibilityIsHidden=!("hidden"!==document.visibilityState&&!t),{"isSuspended":this._pageVisibilityIsHidden}}Attach(){window.addEventListener("focus",()=>this._PostRuntimeEvent("window-focus")),window.addEventListener("blur",()=>{this._PostRuntimeEvent("window-blur",{"parentHasFocus":ParentHasFocus()}),this._mousePointerLastButtons=0}),window.addEventListener("focusin",e=>{IsKeyboardInputElement(e.target)&&this._PostRuntimeEvent("keyboard-blur")}),window.addEventListener("keydown",e=>this._OnKeyEvent("keydown",e)),window.addEventListener("keyup",e=>this._OnKeyEvent("keyup",e)),window.addEventListener("mousedown",e=>this._OnMouseEvent("mousedown",e,d)),window.addEventListener("mousemove",e=>this._OnMouseEvent("mousemove",e,d)),window.addEventListener("mouseup",e=>this._OnMouseEvent("mouseup",e,d)),window.addEventListener("dblclick",e=>this._OnMouseEvent("dblclick",e,c)),window.addEventListener("wheel",e=>this._OnMouseWheelEvent("wheel",e,c)),window.addEventListener("pointerdown",e=>{this._HandlePointerDownFocus(e),this._OnPointerEvent("pointerdown",e)}),this._iRuntime.UsesWorker()&&void 0!==window["onpointerrawupdate"]&&self===self.top?window.addEventListener("pointerrawupdate",e=>this._OnPointerRawUpdate(e)):window.addEventListener("pointermove",e=>this._OnPointerEvent("pointermove",e)),window.addEventListener("pointerup",e=>this._OnPointerEvent("pointerup",e)),window.addEventListener("pointercancel",e=>this._OnPointerEvent("pointercancel",e));const e=()=>this._PlayPendingMedia();window.addEventListener("pointerup",e,!0),window.addEventListener("touchend",e,!0),window.addEventListener("click",e,!0),window.addEventListener("keydown",e,!0),window.addEventListener("gamepadconnected",e,!0),this._iRuntime.IsAndroid()&&!this._iRuntime.IsAndroidWebView()&&navigator["virtualKeyboard"]&&(navigator["virtualKeyboard"]["overlaysContent"]=!0,navigator["virtualKeyboard"].addEventListener("geometrychange",()=>{this._OnAndroidVirtualKeyboardChange(this._GetWindowInnerHeight(),navigator["virtualKeyboard"]["boundingRect"]["height"])})),this._iRuntime.IsiOSWebView()&&(document.scrollingElement.scrollTop=0,document.scrollingElement.scrollLeft=0)}_OnAndroidVirtualKeyboardChange(t,n){if(document.body.style.position="",document.body.style.overflow="",document.body.style.transform="",(this._vkTranslateYOffset=0)<n){const i=document.activeElement;if(i){const o=i.getBoundingClientRect(),s=(o.top+o.bottom)/2,a=(t-n)/2;let e=s-a;0<(e=(e=e>n?n:e)<0?0:e)&&(document.body.style.position="absolute",document.body.style.overflow="visible",document.body.style.transform=`translateY(${-e}px)`,this._vkTranslateYOffset=e)}}}_PostRuntimeEvent(t,n){this.PostToRuntime(t,n||null,e)}_GetWindowInnerWidth(){return this._iRuntime._GetWindowInnerWidth()}_GetWindowInnerHeight(){return this._iRuntime._GetWindowInnerHeight()}_EnableWindowResizeEvent(){this._enableWindowResizeEvent=!0,this._lastWindowWidth=this._iRuntime._GetWindowInnerWidth(),this._lastWindowHeight=this._iRuntime._GetWindowInnerHeight()}_OnWindowResize(){if(!this._isExportToVideo&&this._enableWindowResizeEvent){const e=this._GetWindowInnerWidth(),t=this._GetWindowInnerHeight();if(this._iRuntime.IsAndroidWebView()){if(this._enableAndroidVKDetection){const n=this._iRuntime.CanDoAndroidVirtualKeyboardDetection();if(n&&this._lastWindowWidth===e&&t<this._lastWindowHeight)return this._virtualKeyboardHeight=this._lastWindowHeight-t,void this._OnAndroidVirtualKeyboardChange(this._lastWindowHeight,this._virtualKeyboardHeight);0<this._virtualKeyboardHeight&&(this._virtualKeyboardHeight=0,this._OnAndroidVirtualKeyboardChange(t,this._virtualKeyboardHeight))}this._lastWindowWidth=e,this._lastWindowHeight=t}this.PostToRuntime("window-resize",{"innerWidth":e,"innerHeight":t,"devicePixelRatio":window.devicePixelRatio,"isFullscreen":a.IsDocumentFullscreen(),"cssDisplayMode":this._iRuntime.GetCssDisplayMode()}),this._iRuntime.IsiOSWebView()&&(-1!==this._simulatedResizeTimerId&&clearTimeout(this._simulatedResizeTimerId),this._OnSimulatedResize(e,t,0))}}_ScheduleSimulatedResize(e,t,n){-1!==this._simulatedResizeTimerId&&clearTimeout(this._simulatedResizeTimerId),this._simulatedResizeTimerId=setTimeout(()=>this._OnSimulatedResize(e,t,n),48)}_OnSimulatedResize(e,t,n){const i=this._GetWindowInnerWidth(),o=this._GetWindowInnerHeight();this._simulatedResizeTimerId=-1,i!=e||o!=t?this.PostToRuntime("window-resize",{"innerWidth":i,"innerHeight":o,"devicePixelRatio":window.devicePixelRatio,"isFullscreen":a.IsDocumentFullscreen(),"cssDisplayMode":this._iRuntime.GetCssDisplayMode()}):n<10&&this._ScheduleSimulatedResize(i,o,n+1)}_OnSetTargetOrientation(e){this._targetOrientation=e["targetOrientation"]}_TrySetTargetOrientation(){const t=this._targetOrientation;if(screen["orientation"]&&screen["orientation"]["lock"])screen["orientation"]["lock"](t).catch(e=>console.warn("[Construct] Failed to lock orientation: ",e));else try{let e=!1;screen["lockOrientation"]?e=screen["lockOrientation"](t):screen["webkitLockOrientation"]?e=screen["webkitLockOrientation"](t):screen["mozLockOrientation"]?e=screen["mozLockOrientation"](t):screen["msLockOrientation"]&&(e=screen["msLockOrientation"](t)),e||console.warn("[Construct] Failed to lock orientation")}catch(e){console.warn("[Construct] Failed to lock orientation: ",e)}}_OnFullscreenChange(){if(!this._isExportToVideo){const e=a.IsDocumentFullscreen();e&&"any"!==this._targetOrientation&&this._TrySetTargetOrientation(),this.PostToRuntime("fullscreenchange",{"isFullscreen":e,"innerWidth":this._GetWindowInnerWidth(),"innerHeight":this._GetWindowInnerHeight()})}}_OnFullscreenError(e){console.warn("[Construct] Fullscreen request failed: ",e),this.PostToRuntime("fullscreenerror",{"isFullscreen":a.IsDocumentFullscreen(),"innerWidth":this._GetWindowInnerWidth(),"innerHeight":this._GetWindowInnerHeight()})}_OnVisibilityChange(e){if(this._pageVisibilityIsHidden!==e&&((this._pageVisibilityIsHidden=e)?this._iRuntime._CancelAnimationFrame():this._iRuntime._RequestAnimationFrame(),this.PostToRuntime("visibilitychange",{"hidden":e}),!e)&&this._iRuntime.IsiOSWebView()){const t=()=>{document.scrollingElement.scrollTop=0,document.scrollingElement.scrollLeft=0};setTimeout(t,50),setTimeout(t,100),setTimeout(t,250),setTimeout(t,500)}}_OnKeyEvent(e,t){if(void 0!==t.key&&("Backspace"===t.key&&PreventDefaultOnCanvasOrDoc(t),"nwjs"===this._iRuntime.GetExportType()&&"u"===t.key&&(t.ctrlKey||t.metaKey)&&t.preventDefault(),!this._isExportToVideo)){const n=b.get(t.code)||t.code;this._PostToRuntimeMaybeSync(e,{"code":n,"key":t.key,"which":t.which,"repeat":t.repeat,"altKey":t.altKey,"ctrlKey":t.ctrlKey,"metaKey":t.metaKey,"shiftKey":t.shiftKey,"timeStamp":t.timeStamp},c)}}_OnMouseWheelEvent(e,t,n){this._isExportToVideo||this.PostToRuntime(e,{"clientX":t.clientX,"clientY":t.clientY+this._vkTranslateYOffset,"pageX":t.pageX,"pageY":t.pageY+this._vkTranslateYOffset,"deltaX":t.deltaX,"deltaY":t.deltaY,"deltaZ":t.deltaZ,"deltaMode":t.deltaMode,"timeStamp":t.timeStamp},n)}_OnMouseEvent(e,t,n){this._isExportToVideo||IsCompatibilityMouseEvent(t)||this._PostToRuntimeMaybeSync(e,{"button":t.button,"buttons":t.buttons,"clientX":t.clientX,"clientY":t.clientY+this._vkTranslateYOffset,"pageX":t.pageX,"pageY":t.pageY+this._vkTranslateYOffset,"movementX":t.movementX||0,"movementY":t.movementY||0,"timeStamp":t.timeStamp},n)}_OnPointerEvent(t,n){if(!this._isExportToVideo){let e=0;"mouse"===n.pointerType&&(e=this._mousePointerLastButtons),this._PostToRuntimeMaybeSync(t,{"pointerId":n.pointerId,"pointerType":n.pointerType,"button":n.button,"buttons":n.buttons,"lastButtons":e,"clientX":n.clientX,"clientY":n.clientY+this._vkTranslateYOffset,"pageX":n.pageX,"pageY":n.pageY+this._vkTranslateYOffset,"movementX":n.movementX||0,"movementY":n.movementY||0,"width":n.width||0,"height":n.height||0,"pressure":n.pressure||0,"tangentialPressure":n["tangentialPressure"]||0,"tiltX":n.tiltX||0,"tiltY":n.tiltY||0,"twist":n["twist"]||0,"timeStamp":n.timeStamp},c),"mouse"===n.pointerType&&(this._mousePointerLastButtons=n.buttons)}}_OnPointerRawUpdate(e){this._OnPointerEvent("pointermove",e)}_OnTouchEvent(n,i){if(!this._isExportToVideo)for(let e=0,t=i.changedTouches.length;e<t;++e){const o=i.changedTouches[e];this._PostToRuntimeMaybeSync(n,{"pointerId":o.identifier,"pointerType":"touch","button":0,"buttons":0,"lastButtons":0,"clientX":o.clientX,"clientY":o.clientY+this._vkTranslateYOffset,"pageX":o.pageX,"pageY":o.pageY+this._vkTranslateYOffset,"movementX":i.movementX||0,"movementY":i.movementY||0,"width":2*(o["radiusX"]||o["webkitRadiusX"]||0),"height":2*(o["radiusY"]||o["webkitRadiusY"]||0),"pressure":o["force"]||o["webkitForce"]||0,"tangentialPressure":0,"tiltX":0,"tiltY":0,"twist":o["rotationAngle"]||0,"timeStamp":i.timeStamp},c)}}_HandlePointerDownFocus(e){window!==window.top&&window.focus(),this._IsElementCanvasOrDocument(e.target)&&document.activeElement&&!this._IsElementCanvasOrDocument(document.activeElement)&&document.activeElement.blur()}_IsElementCanvasOrDocument(e){return!e||e===document||e===window||e===document.body||"canvas"===e.tagName.toLowerCase()}_AttachDeviceOrientationEvent(){this._attachedDeviceOrientationEvent||(this._attachedDeviceOrientationEvent=!0,window.addEventListener("deviceorientation",e=>this._OnDeviceOrientation(e)),window.addEventListener("deviceorientationabsolute",e=>this._OnDeviceOrientationAbsolute(e)))}_AttachDeviceMotionEvent(){this._attachedDeviceMotionEvent||(this._attachedDeviceMotionEvent=!0,window.addEventListener("devicemotion",e=>this._OnDeviceMotion(e)))}_OnDeviceOrientation(e){this._isExportToVideo||this.PostToRuntime("deviceorientation",{"absolute":!!e["absolute"],"alpha":e["alpha"]||0,"beta":e["beta"]||0,"gamma":e["gamma"]||0,"timeStamp":e.timeStamp,"webkitCompassHeading":e["webkitCompassHeading"],"webkitCompassAccuracy":e["webkitCompassAccuracy"]},c)}_OnDeviceOrientationAbsolute(e){this._isExportToVideo||this.PostToRuntime("deviceorientationabsolute",{"absolute":!!e["absolute"],"alpha":e["alpha"]||0,"beta":e["beta"]||0,"gamma":e["gamma"]||0,"timeStamp":e.timeStamp},c)}_OnDeviceMotion(i){if(!this._isExportToVideo){let e=null;const o=i["acceleration"];o&&(e={"x":o["x"]||0,"y":o["y"]||0,"z":o["z"]||0});let t=null;const s=i["accelerationIncludingGravity"];s&&(t={"x":s["x"]||0,"y":s["y"]||0,"z":s["z"]||0});let n=null;const a=i["rotationRate"];a&&(n={"alpha":a["alpha"]||0,"beta":a["beta"]||0,"gamma":a["gamma"]||0}),this.PostToRuntime("devicemotion",{"acceleration":e,"accelerationIncludingGravity":t,"rotationRate":n,"interval":i["interval"],"timeStamp":i.timeStamp},c)}}_OnInvokeDownload(e){const t=e["url"],n=e["filename"],i=document.createElement("a"),o=document.body;i.textContent=n,i.href=t,i.download=n,o.appendChild(i),i.click(),o.removeChild(i)}async _OnLoadWebFonts(e){const t=e["webfonts"];await Promise.all(t.map(async e=>{const t=new FontFace(e.name,`url('${e.url}')`);document.fonts.add(t),await t.load()}))}async _OnRasterSvgImage(e){const t=e["blob"],n=e["imageWidth"],i=e["imageHeight"],o=e["surfaceWidth"],s=e["surfaceHeight"],a=e["imageBitmapOpts"],r=await self["C3_RasterSvgImageBlob"](t,n,i,o,s);let d;return{"imageBitmap":d=a?await createImageBitmap(r,a):await createImageBitmap(r),"transferables":[d]}}async _OnGetSvgImageSize(e){return self["C3_GetSvgImageSize"](e["blob"])}async _OnAddStylesheet(e){await AddStyleSheet(e["url"])}_PlayPendingMedia(){const e=[...this._mediaPendingPlay];if(this._mediaPendingPlay.clear(),!this._isSilent)for(const t of e){const n=t.play();n&&n.catch(e=>{this._mediaRemovedPendingPlay.has(t)||this._mediaPendingPlay.add(t)})}}TryPlayMedia(t){if("function"!=typeof t.play)throw new Error("missing play function");this._mediaRemovedPendingPlay.delete(t);let e;try{e=t.play()}catch(e){return void this._mediaPendingPlay.add(t)}e&&e.catch(e=>{this._mediaRemovedPendingPlay.has(t)||this._mediaPendingPlay.add(t)})}RemovePendingPlay(e){this._mediaPendingPlay.delete(e),this._mediaRemovedPendingPlay.add(e)}SetSilent(e){this._isSilent=!!e}_OnHideCordovaSplash(){navigator["splashscreen"]&&navigator["splashscreen"]["hide"]&&navigator["splashscreen"]["hide"]()}_OnDebugHighlight(e){const t=e["show"];if(t){this._debugHighlightElem||(this._debugHighlightElem=document.createElement("div"),this._debugHighlightElem.id="inspectOutline",document.body.appendChild(this._debugHighlightElem));const n=this._debugHighlightElem;n.style.display="",n.style.left=e["left"]-1+"px",n.style.top=e["top"]-1+"px",n.style.width=e["width"]+2+"px",n.style.height=e["height"]+2+"px",n.textContent=e["name"]}else this._debugHighlightElem&&(this._debugHighlightElem.style.display="none")}_OnRegisterSW(){window["C3_RegisterSW"]&&window["C3_RegisterSW"]()}_OnPostToDebugger(e){window["c3_postToMessagePort"]&&(e["from"]="runtime",window["c3_postToMessagePort"](e))}_InvokeFunctionFromJS(e,t){return this.PostToRuntimeAsync("js-invoke-function",{"name":e,"params":t})}_OnScriptCreateWorker(e){const t=e["url"],n=e["opts"],i=e["port2"],o=new Worker(t,n);o.postMessage({"type":"construct-worker-init","port2":i},[i])}_OnAlert(e){alert(e["message"])}_OnScreenReaderTextEvent(e){const t=e["type"];if("create"===t){const n=document.createElement("p");n.id="c3-sr-"+e["id"],n.textContent=e["text"],this._screenReaderTextWrap.appendChild(n)}else if("update"===t){const i=document.getElementById("c3-sr-"+e["id"]);i?i.textContent=e["text"]:console.warn("[Construct] Missing screen reader text with id "+e["id"])}else if("release"===t){const o=document.getElementById("c3-sr-"+e["id"]);o?o.remove():console.warn("[Construct] Missing screen reader text with id "+e["id"])}else console.warn(`[Construct] Unknown screen reader text update '${t}'`)}_SetExportingToVideo(e){this._isExportToVideo=!0;const t=document.createElement("h1");t.id="exportToVideoMessage",t.textContent=e["message"],document.body.prepend(t),document.body.classList.add("exportingToVideo"),this.GetRuntimeInterface().GetMainCanvas().style.display="",this._iRuntime.SetIsExportingToVideo(e["duration"])}_OnExportVideoProgress(e){this._exportVideoProgressMessage=e["message"],-1===this._exportVideoUpdateTimerId&&(this._exportVideoUpdateTimerId=setTimeout(()=>this._DoUpdateExportVideoProgressMessage(),250))}_DoUpdateExportVideoProgressMessage(){this._exportVideoUpdateTimerId=-1;const e=document.getElementById("exportToVideoMessage");e&&(e.textContent=this._exportVideoProgressMessage)}_OnExportedToVideo(e){window.c3_postToMessagePort({"type":"exported-video","arrayBuffer":e["arrayBuffer"],"contentType":e["contentType"],"time":e["time"]})}_OnExportedToImageSequence(e){window.c3_postToMessagePort({"type":"exported-image-sequence","blobArr":e["blobArr"],"time":e["time"],"gif":e["gif"]})}};a.AddDOMHandlerClass(j)}

// workers/jobSchedulerDom.js
"use strict";{const a="dispatchworker.js",b="jobworker.js";self.JobSchedulerDOM=class{constructor(t){this._runtimeInterface=t,this._maxNumWorkers=Math.min(navigator.hardwareConcurrency||2,16),this._dispatchWorker=null,this._jobWorkers=[],this._inputPort=null,this._outputPort=null}async Init(){if(this._hasInitialised)throw new Error("already initialised");this._hasInitialised=!0;const t=this._runtimeInterface.GetScriptFolder()+a,r=(this._dispatchWorker=await this._runtimeInterface.CreateWorker(t,{name:"DispatchWorker"}),new MessageChannel);this._inputPort=r.port1,this._dispatchWorker.postMessage({"type":"_init","in-port":r.port2},[r.port2]),this._outputPort=await this._CreateJobWorker()}async _CreateJobWorker(){const t=this._jobWorkers.length,r=this._runtimeInterface.GetScriptFolder()+b,e=await this._runtimeInterface.CreateWorker(r,{name:"JobWorker"+t}),o=new MessageChannel,s=new MessageChannel;return this._dispatchWorker.postMessage({"type":"_addJobWorker","port":o.port1},[o.port1]),e.postMessage({"type":"init","number":t,"dispatch-port":o.port2,"output-port":s.port2},[o.port2,s.port2]),this._jobWorkers.push(e),s.port1}GetPortData(){return{"inputPort":this._inputPort,"outputPort":this._outputPort,"maxNumWorkers":this._maxNumWorkers}}GetPortTransferables(){return[this._inputPort,this._outputPort]}}}

// scripts/plugins/Touch/dom/domSide.js
"use strict";{const a="touch",b=class extends self.DOMHandler{constructor(e){super(e,a),this.AddRuntimeMessageHandler("request-permission",e=>this._OnRequestPermission(e))}async _OnRequestPermission(e){const t=e["type"];let s=!0;0===t?s=await this._RequestOrientationPermission():1===t&&(s=await this._RequestMotionPermission()),this.PostToRuntime("permission-result",{"type":t,"result":s})}async _RequestOrientationPermission(){if(!self["DeviceOrientationEvent"]||!self["DeviceOrientationEvent"]["requestPermission"])return!0;try{const e=await self["DeviceOrientationEvent"]["requestPermission"]();return"granted"===e}catch(e){return console.warn("[Touch] Failed to request orientation permission: ",e),!1}}async _RequestMotionPermission(){if(!self["DeviceMotionEvent"]||!self["DeviceMotionEvent"]["requestPermission"])return!0;try{const e=await self["DeviceMotionEvent"]["requestPermission"]();return"granted"===e}catch(e){return console.warn("[Touch] Failed to request motion permission: ",e),!1}}};self.RuntimeInterface.AddDOMHandlerClass(b)}

// scripts/plugins/Mouse/dom/domSide.js
"use strict";{const a="mouse",b=class extends self.DOMHandler{constructor(e){super(e,a),this.AddRuntimeMessageHandlers([["cursor",e=>this._OnChangeCursorStyle(e)],["request-pointer-lock",e=>this._OnRequestPointerLock(e)],["release-pointer-lock",()=>this._OnReleasePointerLock()]]),document.addEventListener("pointerlockchange",e=>this._OnPointerLockChange()),document.addEventListener("pointerlockerror",e=>this._OnPointerLockError())}_OnChangeCursorStyle(e){document.documentElement.style.cursor=e}_OnRequestPointerLock(e){this._iRuntime.GetMainCanvas().requestPointerLock(e)}_OnReleasePointerLock(){document.exitPointerLock()}_OnPointerLockChange(){this.PostToRuntime("pointer-lock-change",{"has-pointer-lock":!!document.pointerLockElement})}_OnPointerLockError(){this.PostToRuntime("pointer-lock-error",{"has-pointer-lock":!!document.pointerLockElement})}};self.RuntimeInterface.AddDOMHandlerClass(b)}

// scripts/plugins/Multiplayer/dom/net.js
"use strict";{const a=[],b=2*Math.PI;function clampAngle(t){return(t%=b)<0&&(t+=b),t}function clamp(t,e,s){return t<e?e:s<t?s:t}function lerp(t,e,s){return t+s*(e-t)}function unlerp(t,e,s){return t===e?0:(s-t)/(e-t)}function angleDiff(t,e){if(t===e)return 0;const s=Math.sin(t),i=Math.cos(t),n=Math.sin(e),a=Math.cos(e),r=s*n+i*a;return 1<=r?0:r<=-1?Math.PI:Math.acos(r)}function angleClockwise(t,e){const s=Math.sin(t),i=Math.cos(t),n=Math.sin(e),a=Math.cos(e);return i*n-s*a<=0}function angleLerp(t,e,s){const i=angleDiff(t,e);return angleClockwise(e,t)?clampAngle(t+i*s):clampAngle(t-i*s)}class c{constructor(t,e,s,i,n,a){this._index=t,this._interp=e,this._precision=s,this._tag=i,this._userData=n,this._clientValueTag=a}GetRuntimeData(){return{"tag":this._tag,"interp":this._interp,"userData":this._userData,"cvt":this._clientValueTag}}GetIndex(){return this._index}GetInterp(){return this._interp}GetPrecision(){return this._precision}GetTag(){return this._tag}HasUserData(){return void 0!==this._userData}GetUserData(){return this._userData}GetClientValueTag(){return this._clientValueTag}Clamp(t){switch(this._precision){case 0:return t;case 1:return Math.fround(t);case 2:return 2===this._interp&&(t=clampAngle(t),t/=Math.PI,--t,t*=32767),clamp(0|t,-32768,32767);case 3:return clamp(0|(t=2===this._interp?(t=clampAngle(t))/b*255:t),0,255);default:return t}}Write(t,e,s){switch(this._precision){case 0:t.setFloat64(e,s),e+=8;break;case 1:t.setFloat32(e,s),e+=4;break;case 2:t.setInt16(e,s),e+=2;break;case 3:t.setUint8(e,s),e+=1;break;default:t.setFloat32(e,s),e+=4}return e}MaybeUnpack(t){return 2!==this._interp?t:2===this._precision?(t=t/32767+1)*Math.PI:3===this._precision?(t/=255)*b:t}static InterpNetValue(t,e,s,i,n){switch(t){case 0:return n?s:e;case 1:return lerp(e,s,i);case 2:return angleLerp(e,s,i);default:return n?s:e}}}class d{constructor(t,e){this.timestamp=t,this.data=e}}class e{constructor(t,e,s){this._ro=t,this._domHandler=t.GetDOMHandler(),this._id=e,this._nid=s,this._data=[],this._data.length=this._ro.GetNetValues().length,this._lastChanged=0,this._lastTransmitted=0,this._transmitMe=!1,this._isAlive=!1,this._updates=[],this._priorUpdate2=null,this._priorUpdate=null,this._nextUpdate=null}GetRuntimeData(){const s=[];for(let t=0,e=this._ro.GetNetValues().length;t<e;++t)s.push(this.GetInterp(this._ro.GetSimTime(),t));const t={"id":this._id,"nid":this._nid,"isTimedOut":this.IsTimedOut(),"interpValues":s,"latestUpdate":null},e=this.GetLatestUpdate();return e&&(t["latestUpdate"]={"timestamp":e.timestamp,"data":e.data}),t}GetId(){return this._id}GetNid(){return this._nid}SetAlive(t){this._isAlive=!!t}IsAlive(){return this._isAlive}ShouldTransmit(){return this._transmitMe}UpdateData(t,e){const s=t["netValues"],i=this._ro.GetNetValues(),n=i.length;this._transmitMe=!1;for(let t=0;t<n;++t){const d=i[t],_=d.Clamp(s[t]);this._data[t]!==_&&(this._data[t]=_,this._lastChanged=e,this._ro.SetLastChanged(e))}const a=e-this._lastChanged,r=e-this._lastTransmitted,h=this._ro.GetBandwidth();this._transmitMe=a<100&&0===h||(a<1e3&&h<=1?95<=r:495<=r),this._transmitMe&&this._ro.IncNumberToTransmit()}WriteData(s,i,t){const n=this._ro.GetNetValues();this._lastTransmitted=t,s.setUint16(i,this._nid),i+=2;for(let t=0,e=this._data.length;t<e;++t)i=n[t].Write(s,i,this._data[t]);return i}AddUpdate(s,i){for(let t=0,e=this._updates.length;t<e;++t){const n=this._updates[t];if(n.timestamp===s)return;if(s<n.timestamp)return void this._updates.splice(t,0,new d(s,i))}this._updates.push(new d(s,i))}IsTimedOut(){return 0!==this._updates.length&&this._updates[this._updates.length-1].timestamp<this._ro.GetSimTime()-3e3}Tick(){for(;2<this._updates.length&&this._updates[0]!==this._priorUpdate2&&this._updates[0]!==this._priorUpdate&&this._updates[0]!==this._nextUpdate;)this._updates.shift();const s=this._ro.GetSimTime();if(!(this._nextUpdate&&this._nextUpdate.timestamp>s&&this._priorUpdate&&this._priorUpdate.timestamp<s)){this._nextUpdate=null;for(let t=0,e=this._updates.length;t<e;++t){const i=this._updates[t];if(!(i.timestamp<=s)){this._nextUpdate=i;break}(!this._priorUpdate||i.timestamp>this._priorUpdate.timestamp)&&(this._priorUpdate2=this._priorUpdate,this._priorUpdate=i)}}}GetLatestUpdate(){return 0===this._updates.length?null:this._updates[this._updates.length-1]}GetInterp(e,s,t){if(!this._nextUpdate&&!this._priorUpdate)return 0;if(this._nextUpdate&&!this._priorUpdate)return this._nextUpdate.data[s];const i=this._ro.GetNetValues();let n,a,r,h,d;if(this._nextUpdate||!this._priorUpdate)return n=this._priorUpdate.timestamp,a=this._priorUpdate.data[s],r=this._nextUpdate.timestamp,h=this._nextUpdate.data[s],d=unlerp(n,r,e),c.InterpNetValue(i[s].GetInterp(),a,h,d,!1);if(!this._priorUpdate2||t)return this._priorUpdate.data[s];{n=this._priorUpdate2.timestamp,a=this._priorUpdate2.data[s],r=this._priorUpdate.timestamp,h=this._priorUpdate.data[s];let t=e;return t>this._priorUpdate.timestamp+this._ro.GetExtrapolateLimit()&&(t=this._priorUpdate.timestamp+this._ro.GetExtrapolateLimit()),d=unlerp(n,r,t),c.InterpNetValue(i[s].GetInterp(),a,h,d,!0)}}}class f{constructor(t,e,s,i){switch(this._domHandler=t,this._roId=e,this._sid=s,this._nid=this._domHandler.GetNextObjectNid(),this._bandwidth=i,this._userData={},this._instanceByteSize=0,this._extrapolateLimit=250,this._bandwidth){case 1:this._extrapolateLimit=500;break;case 2:this._extrapolateLimit=2500}this._netValues=[],this._netInstances=[],this._idToNetInst=new Map,this._usedNids=new Set,this._nextNid=0,this._lastChanged=0,this._lastTransmitted=0,this._numberToTransmit=0,this._hasOverriddenNids=!1,this._deadNids=[],this._overrideNids=new Map,this._nidToNetInst=new Map,this._simTime=0,this._domHandler.AddRegisteredObject(this)}GetDOMHandler(){return this._domHandler}GetNetValues(){return this._netValues}GetRoId(){return this._roId}_SetNid(t){this._nid=t}GetNid(){return this._nid}SetLastChanged(t){this._lastChanged=t}GetBandwidth(){return this._bandwidth}IncNumberToTransmit(){this._numberToTransmit++}GetNumberToTransmit(){return this._numberToTransmit}GetSimTime(){return this._simTime}_SetHasOverriddenNids(t){this._hasOverriddenNids=!!t}HasOverriddenNids(){return this._hasOverriddenNids}GetExtrapolateLimit(){return this._extrapolateLimit}GetSid(){return this._sid}GetDeadNids(){return this._deadNids}AddValue(t,e,s,i,n){const a=new c(this._netValues.length,t,e,s,i,n);switch(e){case 0:this._instanceByteSize+=8;break;case 1:this._instanceByteSize+=4;break;case 2:this._instanceByteSize+=2;break;case 3:this._instanceByteSize+=1}this._netValues.push(a)}AddUpdate(t,e,s){const i=this.GetNetInstForNid(e);i.AddUpdate(t,s)}Tick(){this._simTime=this._domHandler.GetSimulationTime();for(const t of this._netInstances)t.Tick()}GetCount(){return this._netInstances.length}GetNetInstAt(t){return(t=Math.floor(t))<0||t>=this._netInstances.length?null:this._netInstances[t]}GetNetInstByNid(t){for(const e of this._netInstances)if(e.GetNid()===t)return e;return null}GetNetValuesJson(){const t=[];for(const e of this._netValues){const s={"tag":e.GetTag(),"precision":e.GetPrecision(),"interp":e.GetInterp(),"clientvaluetag":e.GetClientValueTag()};e.HasUserData()&&(s["userdata"]=e.GetUserData()),t.push(s)}return t}SetNetValuesFrom(t){this._netValues.length=0,this._instanceByteSize=0;for(const e of t)this.AddValue(e["interp"],e["precision"],e["tag"],e["userdata"],e["clientvaluetag"])}GetNetInstForNid(t){let s=this._nidToNetInst.get(t);return s||(s=new e(this,-1,t),this._nidToNetInst.set(t,s),this._netInstances.push(s)),s}GetNetInstForId(t){let s=this._idToNetInst.get(t);return s||(s=new e(this,t,this.AllocateInstanceNid()),this._idToNetInst.set(t,s),this._netInstances.push(s)),s}AllocateInstanceNid(){for(;this._nextNid++,65535<this._nextNid&&(this._nextNid=0),this._usedNids.has(this._nextNid););const t=this._nextNid;return this._usedNids.add(t),t}RemoveNetInstance(t){const e=t.GetId(),s=t.GetNid(),i=(this._domHandler.IsHost()&&!this._hasOverriddenNids&&this._deadNids.push(s),this._idToNetInst.delete(e),this._nidToNetInst.delete(s),this._usedNids.delete(s),this._netInstances.indexOf(t));-1<i&&this._netInstances.splice(i,1)}ClearAllNetInstances(){this._deadNids.length=0,this._idToNetInst.clear(),this._nidToNetInst.clear(),this._usedNids.clear(),this._netInstances.length=0}UpdateData(s,i){this._numberToTransmit=0;for(const t of this._netInstances)t.SetAlive(!1);for(let t=0,e=s.length;t<e;++t){const n=s[t],r=n["uid"],h=this.GetNetInstForId(r);h.SetAlive(!0),h.UpdateData(n,i)}for(const e of this._netInstances)e.IsAlive()||a.push(e);for(const d of a)this.RemoveNetInstance(d);a.length=0}WriteData(t,e,s){t.setUint16(e,this._nid),e+=2;let i=0;this._hasOverriddenNids&&(i=1),t.setUint8(e,i),t.setUint16(e+=1,this._numberToTransmit),t.setUint16(e+=2,this._instanceByteSize),e+=2;for(const n of this._netInstances)n.ShouldTransmit()&&(e=n.WriteData(t,e,s));return e}OverrideNid(t,s){if(this._idToNetInst.has(t))console.warn("OverrideNid passed id "+t+" which is already in use and cannot be overridden");else{if(!this._usedNids.has(s)){const i=new e(this,t,s);return this._idToNetInst.set(t,i),this._usedNids.add(s),this._netInstances.push(i),this._hasOverriddenNids=!0,i}console.warn("OverrideNid passed nid "+s+" which is already in use and cannot be overridden")}}RemoveObjectId(t){const e=this._idToNetInst.get(t);e&&this.RemoveNetInstance(e)}RemoveObjectNid(t){const e=this._nidToNetInst.get(t);e&&this.RemoveNetInstance(e)}GetRuntimeData(){return{"hasOverriddenNids":this.HasOverriddenNids(),"netValues":this._netValues.map(t=>t.GetRuntimeData()),"netInstances":this._netInstances.map(t=>t.GetRuntimeData())}}GetRuntimeInfoRequest(){return{"roId":this._roId,"sid":this._sid,"netValues":this._netValues.map(t=>t.GetRuntimeData())}}}self.C3NetValue=c,self.C3NetUpdate=d,self.C3RegisteredObject=f}

// scripts/plugins/Multiplayer/dom/peer.js
"use strict";{const a=self.C3NetUpdate,b=self.C3NetValue,c=window["RTCPeerConnection"]||window["webkitRTCPeerConnection"]||window["mozRTCPeerConnection"]||window["msRTCPeerConnection"];function CloseIgnoreException(e){if(e)try{e.close()}catch(e){}}const d=[];function unlerp(e,t,s){return e===t?0:(s-e)/(t-e)}function Wait(t){return new Promise(e=>setTimeout(e,t))}class e{constructor(e=1){this._maxParallel=e,this._queue=[],this._activeCount=0}Add(s){return new Promise((e,t)=>{this._queue.push({func:s,resolve:e,reject:t}),this._MaybeStartNext()})}async _MaybeStartNext(){if(this._queue.length&&!(this._activeCount>=this._maxParallel)){this._activeCount++;const t=this._queue.shift();try{const e=await t.func();t.resolve(e)}catch(e){t.reject(e)}this._activeCount--,this._MaybeStartNext()}}}class f{constructor(t,s,n){this._domHandler=t,this._id=s,this._nid=0,this._alias=n,this._pc=null,this._dco=null,this._isOOpen=!1,this._dcr=null,this._isROpen=!1,this._dcu=null,this._isUOpen=!1,this._sendThrottle=new e(1),this._receiveThrottle=new e(1),this._firedOpen=!1,this._firedClose=!1,this._wasRemoved=!1,this._hasConfirmed=!1,this._lastHeardFrom=0,this._connectTime=0,this._errorCount=0,this._availableCompressionFormats=[],this._localClientState=[],this._lastStateChange=0,this._lastStateTransmit=0,this._clientStateUpdates=[],this._priorUpdate2=null,this._priorUpdate=null,this._nextUpdate=null,this._lastPingSent=0,this._awaitingPong=!1,this._lastSentPingId=1,this._lastPingTimes=[],this._latency=0,this._pdv=0,this._domHandler._AddPeer(this)}GetId(){return this._id}GetNid(){return this._nid}_SetNid(e){this._nid=e}GetAlias(){return this._alias}IsHost(){return this===this._domHandler.GetHostPeer()}IsSelf(){return this===this._domHandler.GetSelfPeer()}GetLocalClientState(){return this._localClientState}_SetLastStateChange(e){this._lastStateChange=e}GetLastStateChange(){return this._lastStateChange}_SetLastStateTransmit(e){this._lastStateTransmit=e}GetLastStateTransmit(){return this._lastStateTransmit}GetLatency(){return this._latency}GetPdv(){return this._pdv}_AttachDataChannelHandlers(e,t){e.binaryType="arraybuffer",e.onopen=()=>{"o"===t?this._isOOpen=!0:"r"===t?this._isROpen=!0:"u"===t&&(this._isUOpen=!0),this._MaybeFireOpen()},e.onmessage=e=>{this._OnNetworkMessage(t,e)},e.onerror=e=>{console.error("Peer '"+this._id+"' datachannel '"+t+"' error: ",e),this._domHandler._OnPeerError(this,e),this._domHandler.IsHost()&&!this.IsHost()&&this.Remove("network error")},e.onclose=()=>{this.Remove("disconnect")}}Connect(){if(!this.IsSelf()){const e=this._domHandler.IsHost(),s=(this._isOOpen=!1,this._isROpen=!1,this._isUOpen=!1,this._firedOpen=!1,this._firedClose=!1,this._connectTime=performance.now(),this._pc=new c({"iceServers":this._domHandler.GetICEServerList()}),this._pc.onicecandidate=e=>{e.candidate&&this._domHandler.SignallingSend({"message":"icecandidate","toclientid":this._id,"icecandidate":e.candidate})},this._pc.onsignalingstatechange=()=>{this._pc&&"closed"===this._pc.signalingState&&this.Remove("disconnect")},this._pc.oniceconnectionstatechange=()=>{!this._pc||"failed"!==this._pc.iceConnectionState&&"closed"!==this._pc.iceConnectionState||this.Remove("disconnect")},this._pc["onconnectionstatechange"]=()=>{if(this._pc){const e=this._pc["connectionState"];"failed"!==e&&"closed"!==e||this.Remove("disconnect")}},`c3mp_${this._domHandler.GetCurrentGame()}_${this._domHandler.GetCurrentGameInstance()}_`+this._domHandler.GetCurrentRoom());e?(this._nid=this._domHandler.AllocatePeerNid(),this._dco=this._pc.createDataChannel("o",{ordered:!0,protocol:s}),this._AttachDataChannelHandlers(this._dco,"o"),this._dcr=this._pc.createDataChannel("r",{ordered:!1,protocol:s}),this._AttachDataChannelHandlers(this._dcr,"r"),this._dcu=this._pc.createDataChannel("u",{ordered:!1,maxRetransmits:0,protocol:s}),this._AttachDataChannelHandlers(this._dcu,"u"),this._pc.createOffer().then(e=>{this._pc.setLocalDescription(e),this._domHandler.SignallingSend({"message":"offer","toclientid":this._id,"offer":e})}).catch(e=>{console.error("Host error creating offer for peer '"+this._id+"': ",e),this._domHandler._OnPeerError(this,"could not create offer for peer")})):this._pc.ondatachannel=e=>{if(e.channel.protocol!==s)console.error("Unexpected datachannel protocol '"+e.channel.protocol+"', should be '"+s+"'"),this._domHandler._OnPeerError(this,"unexpected datachannel protocol '"+e.channel.protocol+"', should be '"+s+"'"),this._wasRemoved||(this.Remove("datachannel protocol error"),this._domHandler.OnWasKicked());else{const t=e.channel.label;"o"===t?this._dco=e.channel:"r"===t?this._dcr=e.channel:"u"===t?this._dcu=e.channel:(console.error("Unknown datachannel label: "+e.channel.label),this._domHandler._OnPeerError(this,"unknown datachannel label '"+e.channel.label+"'")),this._AttachDataChannelHandlers(e.channel,t)}}}}async _AddICECandidate(e){if(this._pc)try{await this._pc.addIceCandidate(e)}catch(e){console.warn("[Multiplayer] Error adding ICE candidate: ",e)}}HasPeerConnection(){return!!this._pc}GetPeerConnection(){return this._pc}_MaybeFireOpen(){this._firedOpen||this._isROpen&&this._isUOpen&&this._isOOpen&&(this._OnOpen(),this._firedOpen=!0,this._firedClose=!1)}_OnOpen(){if(this._lastHeardFrom=performance.now(),this._domHandler.IsHost()){this._domHandler.HostBroadcast("o",JSON.stringify({"c":"j","i":this._id,"n":this._nid,"a":this._alias}),0,this),this.Send("o",JSON.stringify({"c":"hi","hn":this._domHandler.GetHostPeer().GetNid(),"n":this._nid,"d":this._domHandler.GetClientDelay(),"u":this._domHandler.GetPeerUpdateRateSec(),"objs":this._domHandler.GetRegisteredObjectsMap(),"cvs":this._domHandler.GetClientValuesJson(),"comp":this._domHandler.GetLocalSupportedCompressionFormats()}));for(const e of this._domHandler.peers())!e.IsHost()&&e!==this&&e.IsOpen()&&this.Send("o",JSON.stringify({"c":"j","i":e.GetId(),"n":e.GetNid(),"a":e.GetAlias()}))}else this._hasConfirmed=!0,this.IsHost()&&this.SendPing(performance.now(),!0),this.Send("o",JSON.stringify({"c":"comp","comp":this._domHandler.GetLocalSupportedCompressionFormats()}));this._domHandler._OnPeerOpen(this)}_MaybeFireClose(e){!this._firedClose&&this._firedOpen&&(this._OnClose(e),this._firedClose=!0,this._firedOpen=!1)}_OnClose(e){this._domHandler.IsHost()&&!this.IsSelf()&&this._domHandler.HostBroadcast("o",JSON.stringify({"c":"l","i":this._id,"a":this._alias,"r":e}),0,this),this.IsSelf()||this._domHandler._OnPeerClose(this,e)}IsOpen(){return this._firedOpen&&!this._firedClose}_DetermineSupportedCompressionFormats(e){const t=this._domHandler.GetLocalSupportedCompressionFormats();for(const s of e)t.includes(s)&&this._availableCompressionFormats.push(s)}async _MaybeCompress(e){if(0===this._availableCompressionFormats.length)return{compressionType:0,data:e};const t=new Blob([e]);if(t.size<64)return{compressionType:0,data:e};const s=this._availableCompressionFormats[0],n=new CompressionStream(s),i=t.stream().pipeThrough(n),r=await new Response(i).arrayBuffer();if(r.byteLength>=t.size)return{compressionType:0,data:e};{const a=f.COMPRESSION_TYPES.indexOf(s);if(a<0)throw new Error("invalid compression type");return{compressionType:a,data:r}}}async Send(e,t,s=0){this._domHandler.StatAddOutboundDecompressedBandwidthCount(t);const n=this._PrepareSend(e,t,s);let i=n;const r=await(i="o"===e?this._sendThrottle.Add(()=>n):i);r&&this._NetworkSend(e,r)}async _PrepareSend(t,e,s=0){let n="string"==typeof e,{compressionType:i,data:r}=await this._MaybeCompress(e),a=r;if(r instanceof ArrayBuffer){0!==i&&(s|=i<<4,n)&&(s|=f.FLAG_STRING_DATA);const l=new ArrayBuffer(r.byteLength+8),_=new DataView(l);_.setUint32(0,f.MAGIC_NUMBER),_.setUint32(4,s),new Uint8Array(l,8).set(new Uint8Array(r)),a=l}this._domHandler.StatIncOutboundCount(),this._domHandler.StatAddOutboundBandwidthCount(a);const o=this._domHandler.GetSimulatedPacketLoss(),d=this._domHandler.GetSimulatedLatency(),h=this._domHandler.GetSimulatedPdv();if(0<o&&"u"===t&&Math.random()<o)return null;if(0!==d||0!==h){let e=1;"u"!==t&&Math.random()<o&&(e=3),await Wait((d+Math.random()*h)*e)}return a}_NetworkSend(t,s){try{"o"===t?this._isOOpen&&this._dco&&this._dco.send(s):"r"===t?this._isROpen&&this._dcr&&this._dcr.send(s):"u"===t&&this._isUOpen&&this._dcu&&this._dcu.send(s)}catch(e){this._wasRemoved||(this._domHandler.IsHost()?"o"===t||"r"===t?("string"==typeof s?(console.error("Error sending "+s.length+"-char string on '"+t+"' to '"+this._alias+"', host kicking: ",e),console.log("String that failed to send from previous error was: "+s)):console.error("Error sending "+(s.length||s.byteLength)+"-byte binary on '"+t+"' to '"+this._alias+"', host kicking: ",e),this.Remove("network error")):(this._errorCount++,10<=this._errorCount&&("string"==typeof s?(console.error("Too many errors ("+this._errorCount+") sending data on '"+t+"' to '"+this._alias+"', kicking; last error was for sending "+s.length+"-char string: ",e),console.log("String that failed to send from previous error was: "+s)):console.error("Too many errors ("+this._errorCount+") sending data on '"+t+"' to '"+this._alias+"', kicking; last error was for sending "+(s.length||s.byteLength)+"-byte binary: ",e),this.Remove("network error"))):console.error("Error sending data on '"+t+"': ",e))}}SendPing(e,t){this._wasRemoved||(!t&&!this.IsOpen()&&this._pc&&25e3<e-this._connectTime?(console.warn("Timed out '"+this._alias+"', could not establish connection after 25sec"),this.Remove("timeout")):!t&&this.IsOpen()&&2e4<e-this._lastHeardFrom?(console.warn("Timed out '"+this._alias+"', not heard from for 20sec"),this.Remove("timeout")):(this._lastPingSent=e,this._awaitingPong=!0,this._lastSentPingId++,this.Send("u","ping:"+this._lastSentPingId)))}SendPong(e){let t="pong:"+e.substr(5);this._domHandler.IsHost()&&(t=(t+="/")+Math.round(performance.now()).toString()),this.Send("u",t)}_OnPong(e){if(this._awaitingPong){const i=e.indexOf(":");if(-1<i){{const o=parseFloat(e.substr(i+1));if(o!==this._lastSentPingId)return}const r=performance.now(),a=(this._awaitingPong=!1,(r-this._lastPingSent)/2);this._lastPingTimes.push(a),10<this._lastPingTimes.length&&this._lastPingTimes.shift(),d.push(...this._lastPingTimes),d.sort((e,t)=>e-t),this._pdv=d[d.length-1]-d[0];let t=0,s=d.length,n=(4<=d.length&&d.length<=6?(++t,--s):6<d.length&&(t+=2,s-=2),0);for(let e=t;e<s;++e)n+=d[e];if(this._latency=n/(s-t),d.length=0,!this._domHandler.IsHost()){const h=e.indexOf("/");if(-1<h){const l=parseFloat(e.substr(h+1));isFinite(l)?this._domHandler.AddHostTime(l,r,a,this._latency):console.warn("Invalid host time from pong response")}else console.warn("Cannot parse off host time from pong response")}}else console.warn("Cannot parse off ping ID from pong")}}async _OnNetworkMessage(e,t){const s=this._PrepareReceive(e,t.data);let n=s;const i=await(n="o"===e?this._receiveThrottle.Add(()=>s):n);i&&this._HandleReceivedMessage(e,i)}async _PrepareReceive(t,e){this._domHandler.StatIncInboundCount(),this._domHandler.StatAddInboundBandwidthCount(e);const s=this._domHandler.GetSimulatedPacketLoss(),n=this._domHandler.GetSimulatedLatency(),i=this._domHandler.GetSimulatedPdv();if(0<s&&"u"===t&&Math.random()<s)return null;if(0!==n||0!==i){let e=1;await Wait(n*(e="u"!==t&&Math.random()<s?3:e)+Math.random()*i*e)}return e instanceof ArrayBuffer?this._ReadBinaryHeaderAndMaybeDecompress(e):e}async _ReadBinaryHeaderAndMaybeDecompress(e){if(e.byteLength<8)return console.warn(`Rejected binary message as too small (only ${e.byteLength} bytes)`),null;const t=new DataView(e),s=t.getUint32(0),n=t.getUint32(4);if(s!==f.MAGIC_NUMBER)return console.warn(`Rejected binary message with invalid magic number (0x${s.toString(16)})`),null;const i=(n&f.FLAG_COMPRESSION_MASK)>>4;if(0==i)return{data:e,offset:8,flags:n};{if(i>=f.COMPRESSION_TYPES.length)throw new Error("invalid compression type");const r=f.COMPRESSION_TYPES[i],a=new Blob([new Uint8Array(e,8)]),o=new DecompressionStream(r),d=a.stream().pipeThrough(o),h=await new Response(d).arrayBuffer();return 0==(n&f.FLAG_STRING_DATA)?{data:h,offset:0,flags:n}:(new TextDecoder).decode(h)}}_HandleReceivedMessage(e,t){if(!this._wasRemoved)if(this._lastHeardFrom=performance.now(),"string"==typeof t){if(this._domHandler.StatAddInboundDecompressedBandwidthCount(t),!(""===t.trim()||t.length<4)){const n=t.substr(0,4);if("ping"===n)this.SendPong(t);else if("pong"===n)this._OnPong(t);else{var s;try{s=JSON.parse(t)}catch(e){return this._domHandler._OnPeerError(this,e),this._domHandler.IsHost()?(console.error("Error parsing message as JSON for peer '"+this._id+"', host kicking: ",e),this.Remove("data error")):console.error("Error parsing message as JSON for peer '"+this._id+"': ",e),void console.log("String that failed to parse from previous error: "+t)}if(s)try{s["c"]&&"m"!==s["c"]?this._OnControlMessage(s):this._domHandler._OnPeerMessage(this,s,e)}catch(e){this._domHandler._OnPeerError(this,e),this._domHandler.IsHost()?(console.error("Error handling message for peer '"+this._id+"', host kicking: ",e),this.Remove("data error")):console.error("Error handling message for peer '"+this._id+"': ",e)}}}}else{this._domHandler.StatAddInboundDecompressedBandwidthCount(t.data),!this._hasConfirmed&&this._domHandler.IsHost()&&"u"===e&&(this._hasConfirmed=!0,this._domHandler.SignallingConfirmPeer(this._id));try{const i=t.data,r=t.offset,a=t.flags;this._OnBinaryMessage(i,r,a,e)}catch(e){this._domHandler._OnPeerError(this,e),this._domHandler.IsHost()?(console.error("Error handling binary update for peer '"+this._id+"', host kicking: ",e),this.Remove("data error")):console.error("Error handling binary update for peer '"+this._id+"': ",e)}}}_OnControlMessage(e){let t,s;switch(e["c"]){case"disconnect":e["k"]&&this._domHandler.OnWasKicked(),s=!this._domHandler.IsHost()&&!this.IsHost(),this.Remove(e["r"]),s&&this._domHandler.SignallingLeaveRoom();break;case"hi":this._domHandler.IsHost()||(this._domHandler.GetHostPeer()._SetNid(e["hn"]),this._domHandler.GetSelfPeer()._SetNid(e["n"]),this._domHandler.SetClientDelay(e["d"]),this._domHandler.SetPeerUpdateRateSec(e["u"]),this._domHandler.MapObjectNids(e["objs"]),this._domHandler.MapClientValues(e["cvs"]),e.hasOwnProperty("comp")&&this._DetermineSupportedCompressionFormats(e["comp"]));break;case"comp":this._DetermineSupportedCompressionFormats(e["comp"]);break;case"j":this._domHandler.IsHost()||((t=new f(this._domHandler,e["i"],e["a"]))._SetNid(e["n"]),this._domHandler._OnPeerOpen(t));break;case"l":this._domHandler.IsHost()||(t=this._domHandler.GetPeerById(e["i"]))&&(t.IsSelf()||this._domHandler._OnPeerClose(t,e["r"]),t.Remove(e["r"]));break;default:console.error("Unknown control message from peer '"+this._id+"': "+e["c"]),this._domHandler._OnPeerError(this,"unknown control message '"+e["c"]+"'")}}_OnBinaryMessage(e,t,s,n){if(0==(s&f.FLAG_SCRIPT_DATA)){const i=new DataView(e,t);this._domHandler.IsHost()?this._OnHostUpdate(i,s):this._OnPeerUpdate(i,s)}else this._domHandler._OnPeerBinaryMessage(this,0===t?e:e.slice(t),n)}_OnHostUpdate(s,e){let n=0,t=s.getFloat64(n);if(n+=8,t+=this._latency,!(3e3<=Math.abs(t-performance.now()))){const i=s.getUint8(n),r=(n+=1,[]),a=this._domHandler.GetClientValues();for(let t=0;t<i;++t)if(t>=a.length)r.push(0);else{const o=a[t];let e=0;switch(o.GetPrecision()){case 0:e=s.getFloat64(n),n+=8;break;case 1:e=s.getFloat32(n),n+=4;break;case 2:e=o.MaybeUnpack(s.getInt16(n)),n+=2;break;case 3:e=o.MaybeUnpack(s.getUint8(n)),n+=1;break;default:e=s.getFloat32(n),n+=4}r.push(e)}this._AddClientUpdate(t,r)}}_AddClientUpdate(s,n){for(let e=0,t=this._clientStateUpdates.length;e<t;++e){const i=this._clientStateUpdates[e];if(i.timestamp===s)return;if(s<i.timestamp)return void this._clientStateUpdates.splice(e,0,new a(s,n))}this._clientStateUpdates.push(new a(s,n))}Tick(s){if(0!==this._clientStateUpdates.length){for(;2<this._clientStateUpdates.length&&this._clientStateUpdates[0]!==this._priorUpdate2&&this._clientStateUpdates[0]!==this._priorUpdate&&this._clientStateUpdates[0]!==this._nextUpdate;)this._clientStateUpdates.shift();if(!(this._nextUpdate&&this._nextUpdate.timestamp>s&&this._priorUpdate&&this._priorUpdate.timestamp<s)){this._nextUpdate=null;for(let e=0,t=this._clientStateUpdates.length;e<t;++e){const n=this._clientStateUpdates[e];if(!(n.timestamp<=s)){this._nextUpdate=n;break}(!this._priorUpdate||n.timestamp>this._priorUpdate.timestamp)&&(this._priorUpdate2=this._priorUpdate,this._priorUpdate=n)}}}}_OnPeerUpdate(e,t){0==(t&f.FLAG_HOST_UPDATE_TYPE)?this._HandlePeerUpdate(e):this._HandlePeerEvents(e)}_HandlePeerUpdate(r){let t=0;const a=r.getFloat64(t),s=(t+=8,r.getUint16(t));t+=2;for(let e=0;e<s;++e){const o=r.getUint16(t),d=(t+=2,r.getUint8(t));t+=1;let n=null,i=0;const h=this._domHandler.GetRegisteredObjectByNid(o),l=(h?(n=h.GetNetValues(),i=n.length,1===d&&h._SetHasOverriddenNids(!0)):console.warn("Don't know which object corresponds to NID "+o),r.getUint16(t)),_=(t+=2,r.getUint16(t));t+=2;for(let e=0;e<l;++e){const c=r.getUint16(t);if(t+=2,h){const p=[];let s=t;for(let t=0;t<i;++t){const m=n[t];let e=0;switch(m.GetPrecision()){case 0:e=r.getFloat64(s),s+=8;break;case 1:e=r.getFloat32(s),s+=4;break;case 2:e=m.MaybeUnpack(r.getInt16(s)),s+=2;break;case 3:e=m.MaybeUnpack(r.getUint8(s)),s+=1;break;default:e=r.getFloat32(s),s+=4}p.push(e)}h.AddUpdate(a,c,p)}t+=_}}}_HandlePeerEvents(t){let s=0;const n=t.getFloat64(s),i=(s+=8,t.getUint16(s));s+=2;for(let e=0;e<i;++e){const r=t.getUint16(s),a=(s+=2,this._domHandler.GetRegisteredObjectByNid(r)),o=(a||console.warn("Don't know which object corresponds to NID "+r),t.getUint16(s));s+=2;for(let e=0;e<o;++e){const d=t.getUint16(s);s+=2,!a||a.HasOverriddenNids()||(this._domHandler._OnInstanceDestroyed(a,d,n),a.RemoveObjectNid(d))}}}Remove(e,t){this._wasRemoved||(this._wasRemoved=!0,this._MaybeFireClose(e),this.Send("o",JSON.stringify({"c":"disconnect","r":e,"k":!!t})).then(()=>{const e=this._dco,t=this._dcr,s=this._dcu,n=this._pc;setTimeout(()=>{CloseIgnoreException(e),CloseIgnoreException(t),CloseIgnoreException(s),CloseIgnoreException(n)},1),this._dco=null,this._dcr=null,this._dcu=null,this._pc=null,this._isOOpen=!1,this._isROpen=!1,this._isUOpen=!1}),this._domHandler._RemovePeer(this))}HasClientState(e){return this._domHandler.HasClientValueTag(e)}GetClientState(e){const t=this._domHandler.GetClientValueByTag(e);if(!t)return 0;const s=t.GetIndex();if(0===this._clientStateUpdates.length)return 0;const n=this._clientStateUpdates[this._clientStateUpdates.length-1].data;return s<0||s>=n.length?0:n[s]}GetInterpClientState(e){const t=e.GetIndex();if(!this._nextUpdate&&!this._priorUpdate)return 0;if(this._nextUpdate&&!this._priorUpdate){const d=this._nextUpdate.data;return t<0||t>=d.length?0:d[t]}const s=this._domHandler.GetSimulationTime();let n,i,r,a,o;if(this._nextUpdate||!this._priorUpdate)return n=this._priorUpdate.timestamp,i=this._priorUpdate.data[t],r=this._nextUpdate.timestamp,a=this._nextUpdate.data[t],o=unlerp(n,r,s),b.InterpNetValue(this._domHandler.GetClientValues()[t].GetInterp(),i,a,o,!1);if(this._priorUpdate2){n=this._priorUpdate2.timestamp,i=this._priorUpdate2.data[t],r=this._priorUpdate.timestamp,a=this._priorUpdate.data[t];let e=s;return e>this._priorUpdate.timestamp+250&&(e=this._priorUpdate.timestamp+250),o=unlerp(n,r,e),b.InterpNetValue(this._domHandler.GetClientValues()[t].GetInterp(),i,a,o,!0)}{const h=this._priorUpdate.data;return t<0||t>=h.length?0:h[t]}}}f.MAGIC_NUMBER=1664314736,f.FLAG_HOST_UPDATE_TYPE=1,f.FLAG_STRING_DATA=2,f.FLAG_SCRIPT_DATA=4,f.FLAG_COMPRESSION_MASK=240,f.COMPRESSION_TYPES=["none","deflate","gzip"],self.C3Peer=f}

// scripts/plugins/Multiplayer/dom/domSide.js
"use strict";{const a=self.C3NetValue,b=self.C3Peer,c="multiplayer",d=window["RTCPeerConnection"]||window["webkitRTCPeerConnection"]||window["mozRTCPeerConnection"]||window["msRTCPeerConnection"],e=window["RTCSessionDescription"]||window["webkitRTCSessionDescription"]||window["mozRTCSessionDescription"]||window["msRTCSessionDescription"],f=window["RTCIceCandidate"]||window["webkitRTCIceCandidate"]||window["mozRTCIceCandidate"]||window["msRTCIceCandidate"],g=window["RTCDataChannel"]||window["webkitRTCDataChannel"]||window["mozRTCDataChannel"]||window["msRTCDataChannel"],h="c2multiplayer",i=1,j=2,k=[{"urls":"stun:stun.l.google.com:19302"}];function SupportsCompressionStreamFormat(e){if("undefined"==typeof CompressionStream||"function"!=typeof Blob.prototype.stream)return!1;try{return new CompressionStream(e),!0}catch(e){return!1}}function GetDataSize(e){return"number"==typeof e.byteLength?e.byteLength:"number"==typeof e.length?e.length:(console.warn("[Construct] Multiplayer: don't know how to measure size of data: ",e),0)}const l=[],m=(SupportsCompressionStreamFormat("deflate")&&l.push("deflate"),SupportsCompressionStreamFormat("gzip")&&l.push("gzip"),0),n=1,o=2;let t=!1;const q=[],r=class extends self.DOMHandler{constructor(e){super(e,c),this._iceServers=[],this._sigWs=null,this._isSignallingConnected=!1,this._isSignallingLoggedIn=!1,this._sigservInfo={protocolrev:0,version:0,name:"",operator:"",motd:""},this._myId="",this._myAlias="",this._game="",this._gameInstance="",this._room="",this._allPeers=[],this._peersById=new Map,this._nextPeerNid=0,this._usedPeerNids=new Set,this._selfPeer=null,this._hostPeer=null,this._clientDelay=80,this._hostUpdateRateSec=30,this._peerUpdateRateSec=30,this._lastUpdateTime=0,this._stats={lastSecondTime:0,outboundPerSec:0,outboundCount:0,outboundBandwidthPerSec:0,outboundDecompressedBandwidthPerSec:0,outboundBandwidthCount:0,outboundDecompressedBandwidthCount:0,inboundPerSec:0,inboundCount:0,inboundBandwidthPerSec:0,inboundDecompressedBandwidthPerSec:0,inboundBandwidthCount:0,inboundDecompressedBandwidthCount:0},this._dataBuffer=new ArrayBuffer(262144),this._dataView=new DataView(this._dataBuffer),this._allRegisteredObjects=[],this._nextObjectNid=1,this._registeredObjectsByNid=new Map,this._registeredObjectsByRoId=new Map,this._simLatency=0,this._simPdv=0,this._simPacketLoss=0,this._lastTimeDiffs=[],this._targetHostTimeDiff=0,this._hostTimeDiff=0,this._targetSimDelay=this._clientDelay,this._simDelay=this._clientDelay,this._allClientValues=[],this._clientValuesByTag=new Map,this._receivedClientValues=!1,this._signallingPromises={connect:{resolve:null,reject:null},login:{resolve:null,reject:null},joinRoom:{resolve:null,reject:null},leaveRoom:{resolve:null,reject:null},listGameInstances:{resolve:null,reject:null},listRooms:{resolve:null,reject:null}},this._MergeICEServerList(k),setInterval(()=>this._DoPings(),2e3),window.addEventListener("unload",()=>this.RemoveAllPeers("quit")),this.AddRuntimeMessageHandler("get-supported",()=>this._OnGetSupported()),this.AddRuntimeMessageHandler("add-ice-servers",e=>this._MergeICEServerList(e["list"])),this.AddRuntimeMessageHandler("simulate-latency",e=>this.SetLatencySimulation(e["latency"],e["pdv"],e["loss"])),this.AddRuntimeMessageHandler("set-bandwidth-profile",e=>this.SetBandwidthSettings(e["updateRate"],e["delay"])),this.AddRuntimeMessageHandler("tick",e=>this.Tick(e)),this.AddRuntimeMessageHandler("alert",e=>this.Alert(e)),this.AddRuntimeMessageHandler("signalling-connect",e=>this.SignallingConnect(e["url"])),this.AddRuntimeMessageHandler("signalling-disconnect",()=>this.SignallingDisconnect()),this.AddRuntimeMessageHandler("signalling-login",e=>this.SignallingLogin(e["alias"])),this.AddRuntimeMessageHandler("signalling-join-room",e=>this.SignallingJoinGameRoom(e["game"],e["instance"],e["room"],e["maxClients"])),this.AddRuntimeMessageHandler("signalling-auto-join-room",e=>this.SignallingAutoJoinGameRoom(e["game"],e["instance"],e["room"],e["maxClients"],e["lock"])),this.AddRuntimeMessageHandler("signalling-leave-room",()=>this.SignallingLeaveRoom()),this.AddRuntimeMessageHandler("signalling-list-game-instances",e=>this.SignallingRequestGameInstanceList(e["game"])),this.AddRuntimeMessageHandler("signalling-list-rooms",e=>this.SignallingRequestRoomList(e["game"],e["instance"],e["which"])),this.AddRuntimeMessageHandler("disconnect-room",()=>this.DisconnectRoom(!0)),this.AddRuntimeMessageHandler("peer-send-message",e=>this.OnPeerSendMessage(e)),this.AddRuntimeMessageHandler("host-broadcast",e=>this.OnHostBroadcast(e)),this.AddRuntimeMessageHandler("kick-peer",e=>this.OnKickPeer(e)),this.AddRuntimeMessageHandler("sync-object",e=>this.OnSyncObject(e)),this.AddRuntimeMessageHandler("sync-inst-var",e=>this.OnSyncInstVar(e)),this.AddRuntimeMessageHandler("associate-object",e=>this.OnAssociateObject(e)),this.AddRuntimeMessageHandler("remove-object-id",e=>this.RemoveObjectId(e["uid"])),this.AddRuntimeMessageHandler("remove-net-insts",e=>this.OnRemoveNetInsts(e)),this.AddRuntimeMessageHandler("remove-object-nid",e=>this.OnRemoveObjectNid(e)),this.AddRuntimeMessageHandler("set-client-state",e=>this.SetClientState(e["tag"],e["value"])),this.AddRuntimeMessageHandler("add-client-input-value",e=>this.AddClientInputValue(e["tag"],e["precision"],e["interp"]))}_GetErrorMessage(e){return e?"string"==typeof e?e:"string"==typeof e["message"]?e["message"]:"string"==typeof e["details"]?e["details"]:"string"==typeof e["data"]?e["data"]:"string"==typeof e["type"]?e["type"]:"unknown error":"unknown error"}IsConnected(){return this._isSignallingConnected}IsLoggedIn(){return this.IsConnected()&&this._isSignallingLoggedIn}IsInRoom(){return!!this._room}IsHost(){return this.IsInRoom()&&this._selfPeer&&this._hostPeer===this._selfPeer}GetMyId(){return this._myId}GetMyAlias(){return this._myAlias}GetCurrentGame(){return this._game}GetCurrentGameInstance(){return this._gameInstance}GetCurrentRoom(){return this._room}GetHostId(){return this._hostPeer?this._hostPeer.GetId():""}GetHostAlias(){return this._hostPeer?this._hostPeer.GetAlias():""}GetHostPeer(){return this._hostPeer}GetSelfPeer(){return this._selfPeer}SetLatencySimulation(e,t,s){this._simLatency=Math.max(e,0),this._simPdv=Math.max(t,0),this._simPacketLoss=Math.max(s,0)}GetSimulatedPacketLoss(){return this._simPacketLoss}GetSimulatedLatency(){return this._simLatency}GetSimulatedPdv(){return this._simPdv}_OnGetSupported(){return{"isSupported":!(!d||!g)}}_CreateSignallingPromise(s){return s.reject&&s.reject("overlapping signalling operation"),new Promise((e,t)=>{s.resolve=e,s.reject=t})}_ResolveSignallingPromise(e,t){e.resolve&&e.resolve(t),e.resolve=null,e.reject=null}_RejectSignallingPromises(e){for(const t of Object.values(this._signallingPromises))t.reject&&t.reject(e),t.resolve=null,t.reject=null}SignallingConnect(e){if(this._sigWs||this._isSignallingConnected)return Promise.resolve();const t=this._CreateSignallingPromise(this._signallingPromises.connect);try{this._sigWs=new WebSocket(e,h)}catch(e){return this._sigWs=null,this._OnSignallingError(e),t}return this._sigWs.onopen=()=>{-1===this._sigWs.protocol.indexOf(h)?(this._OnSignallingError("server does not support '"+h+"' protocol"),this._sigWs.close(1002,"'"+h+"' protocol required"),this._sigWs=null,this._isSignallingConnected=!1):this._isSignallingConnected=!0},this._sigWs.onclose=e=>{this._OnSignallingClose(),this._isSignallingConnected=!1,this._isSignallingLoggedIn=!1,this._sigWs=null},this._sigWs.onerror=e=>{console.error("Signalling server error: ",e),this._OnSignallingError(e)},this._sigWs.onmessage=e=>{this._OnSignallingMessage(e)},t}SignallingDisconnect(){this._sigWs&&this._isSignallingConnected&&(this._sigWs.close(),this._sigWs=null,this._isSignallingConnected=!1)}_OnSignallingMessage(e){let t;try{t=JSON.parse(e.data)}catch(e){return void this._OnSignallingError(e)}switch(t["message"]){case"welcome":this._OnSignallingReceiveWelcome(t);break;case"login-ok":this._OnSignallingReceiveLoginOK(t);break;case"join-ok":this._OnSignallingReceiveJoinOK(t);break;case"leave-ok":this._OnSignallingReceiveLeaveOK(t);break;case"kicked":this._OnSignallingReceiveKicked(t);break;case"peer-joined":this._OnSignallingReceivePeerJoined(t);break;case"peer-quit":this._OnSignallingReceivePeerQuit(t);break;case"icecandidate":this._OnSignallingReceiveIceCandidate(t);break;case"offer":this._OnSignallingReceiveOffer(t);break;case"answer":this._OnSignallingReceiveAnswer(t);break;case"instance-list":this._OnSignallingReceiveInstanceList(t);break;case"room-list":this._OnSignallingReceiveRoomList(t);break;case"error":this._OnSignallingError(t["details"]);break;default:this._OnSignallingError("received unknown signalling message")}}HasICEServerUrl(e){for(const t of this._iceServers)if(t["urls"]===e["urls"])return!0;return!1}_MergeICEServerList(t){if(t)for(let e of t)"string"==typeof e&&(e={"urls":e}),this.HasICEServerUrl(e)||(e.hasOwnProperty("url")||(e["url"]=e["urls"]),this._iceServers.push(e))}GetICEServerList(){return this._iceServers}_OnSignallingError(e){this.PostToRuntime("signalling-error",{"message":this._GetErrorMessage(e)}),this._RejectSignallingPromises(e)}_OnSignallingClose(){this.PostToRuntime("signalling-close")}_OnSignallingReceiveWelcome(e){if(e["protocolrev"]<1||e["protocolrev"]>i)this._OnSignallingError("signalling server protocol revision not supported"),this.SignallingDisconnect();else{this._myId=e["clientid"],this._room="";const t=this._sigservInfo;t.protocolrev=e["protocolrev"],t.version=e["version"],t.name=e["name"],t.operator=e["operator"],t.motd=e["motd"],this._MergeICEServerList(e["ice_servers"]),this.PostToRuntime("signalling-welcome",{"myid":this._myId,"sigservinfo":{"protocolrev":t.protocolrev,"version":t.version,"name":t.name,"operator":t.operator,"motd":t.motd}}),this._ResolveSignallingPromise(this._signallingPromises.connect)}}_OnSignallingReceiveLoginOK(e){this._myAlias=e["alias"],this._isSignallingLoggedIn=!0,this.PostToRuntime("signalling-login-ok",{"myalias":this._myAlias}),this._ResolveSignallingPromise(this._signallingPromises.login)}GetNextObjectNid(){return this._nextObjectNid++}AllocatePeerNid(){if(this.IsHost()){for(;this._nextPeerNid++,65535<this._nextPeerNid&&(this._nextPeerNid=0),this._usedPeerNids.has(this._nextPeerNid););const e=this._nextPeerNid;return this._usedPeerNids.add(e),e}}FreePeerNid(e){this.IsHost()&&this._usedPeerNids.delete(e)}_OnSignallingReceiveJoinOK(e){this.RemoveAllPeers("disconnect"),this._game=e["game"],this._gameInstance=e["instance"],this._room=e["room"],this._selfPeer=new b(this,this._myId,this._myAlias),e["host"]?(this._hostPeer=this._selfPeer,this._nextPeerNid=0,this._usedPeerNids.clear(),this._hostPeer._SetNid(this.AllocatePeerNid())):(this._lastTimeDiffs.length=0,this._targetHostTimeDiff=0,this._hostTimeDiff=0,this._clientDelay=80,this._hostUpdateRateSec=30,this._peerUpdateRateSec=30,this._targetSimDelay=this._clientDelay,this._simDelay=this._clientDelay,this._hostPeer=new b(this,e["hostid"],e["hostalias"]),this._hostPeer.Connect()),this.PostToRuntime("signalling-join-ok",{"isHost":!!e["host"],"hostId":this._hostPeer.GetId(),"hostAlias":this._hostPeer.GetAlias(),"game":this._game,"gameInstance":this._gameInstance,"room":this._room}),this._ResolveSignallingPromise(this._signallingPromises.joinRoom)}_OnSignallingReceiveLeaveOK(e){this._room="",this.PostToRuntime("signalling-leave-ok"),this._ResolveSignallingPromise(this._signallingPromises.leaveRoom)}_OnSignallingReceiveKicked(e){const t=e["reason"];"host-left"===t?this.SignallingDisconnect():(this.DisconnectRoom(),this._room="",this.PostToRuntime("signalling-kicked"))}_OnSignallingReceivePeerJoined(e){if(this._isSignallingLoggedIn&&this._room&&this.IsHost()){const t=this._peersById.get(e["peerid"]),s=(t&&t.Remove("rejoin"),new b(this,e["peerid"],e["peeralias"]));s.Connect()}}_OnSignallingReceivePeerQuit(e){if(this._isSignallingLoggedIn&&this._room&&this.IsHost()){const t=this._peersById.get(e["id"]);t&&t.Remove(e["reason"])}}_OnSignallingReceiveIceCandidate(e){if(this._isSignallingLoggedIn&&this._room){const t=this._peersById.get(e["from"]);t&&t._AddICECandidate(new f(e["icecandidate"]))}}_OnSignallingReceiveOffer(t){if(this._isSignallingLoggedIn&&this._room&&!this.IsHost()&&this._selfPeer&&this._hostPeer&&this._hostPeer.HasPeerConnection()&&t["from"]===this._hostPeer.GetId()){const s=this._hostPeer.GetPeerConnection();s.setRemoteDescription(new e(t["offer"])).then(()=>{s.createAnswer().then(e=>{s.setLocalDescription(e),this.SignallingSend({"message":"answer","toclientid":this._hostPeer.GetId(),"answer":e})}).catch(e=>{console.error("Peer error creating answer: ",e),this._OnPeerError(this._selfPeer,"could not create answer to host offer")})}).catch(e=>{console.error("Peer error setting remote description: ",e),this._OnPeerError(this._selfPeer,"could not set remote description")})}}_OnSignallingReceiveAnswer(t){if(this._isSignallingLoggedIn&&this._room&&this.IsHost()){const s=this._peersById.get(t["from"]);s&&s.GetPeerConnection().setRemoteDescription(new e(t["answer"])).catch(e=>{console.error("Host error setting remote description: ",e)})}}_OnSignallingReceiveInstanceList(e){this.PostToRuntime("signalling-instance-list",{"list":e["list"]}),this._ResolveSignallingPromise(this._signallingPromises.listGameInstances)}_OnSignallingReceiveRoomList(e){this.PostToRuntime("signalling-room-list",{"list":e["list"]}),this._ResolveSignallingPromise(this._signallingPromises.listRooms)}SignallingSend(e){this._sigWs&&this._isSignallingConnected&&this._sigWs.send(JSON.stringify(e))}SignallingLogin(e){if(!this._isSignallingLoggedIn){const t=this._CreateSignallingPromise(this._signallingPromises.login);return this.SignallingSend({"message":"login","protocolrev":i,"datachannelrev":j,"compressionformats":this.GetLocalSupportedCompressionFormats(),"alias":e}),t}}SignallingJoinGameRoom(e,t,s,i){if(this._isSignallingLoggedIn&&!this._room){const n=this._CreateSignallingPromise(this._signallingPromises.joinRoom);return this.SignallingSend({"message":"join","game":e,"instance":t,"room":s,"max_clients":i}),n}}SignallingAutoJoinGameRoom(e,t,s,i,n){if(this._isSignallingLoggedIn&&!this._room){const o=this._CreateSignallingPromise(this._signallingPromises.joinRoom);return this.SignallingSend({"message":"auto-join","game":e,"instance":t,"room":s,"max_clients":i,"lock_when_full":n}),o}}SignallingLeaveRoom(){if(this._isSignallingLoggedIn){const e=this._CreateSignallingPromise(this._signallingPromises.leaveRoom);return this.SignallingSend({"message":"leave"}),e}}SignallingConfirmPeer(e){this._isSignallingLoggedIn&&this.IsHost()&&this.SignallingSend({"message":"confirm-peer","id":e})}SignallingRequestGameInstanceList(e){if(this._sigWs&&this._isSignallingConnected){const t=this._CreateSignallingPromise(this._signallingPromises.listGameInstances);return this.SignallingSend({"message":"list-instances","game":e}),t}}SignallingRequestRoomList(e,t,s){if(this._sigWs&&this._isSignallingConnected){const i=this._CreateSignallingPromise(this._signallingPromises.listRooms);return this.SignallingSend({"message":"list-rooms","game":e,"instance":t,"which":s}),i}}DisconnectRoom(e){this._lastTimeDiffs.length=0,this._targetHostTimeDiff=0,this._hostTimeDiff=0,this.RemoveAllPeers("disconnect");for(const t of this._allRegisteredObjects)t.ClearAllNetInstances();e&&this.SignallingLeaveRoom()}_AddPeer(e){this._allPeers.push(e),this._peersById.set(e.GetId(),e),this.PostToRuntime("add-peer",{"id":e.GetId(),"alias":e.GetAlias()})}_RemovePeer(e){this.PostToRuntime("remove-peer",{"id":e.GetId()}),this.IsHost()&&this.FreePeerNid(e.GetNid());const t=this._allPeers.indexOf(e);-1<t&&this._allPeers.splice(t,1),this._peersById.delete(e.GetId()),this._hostPeer===e&&(this._hostPeer=null,this.RemoveAllPeers("host quit")),this._selfPeer===e&&(this._selfPeer=null,this._room="",this.RemoveAllPeers("disconnect"))}RemoveAllPeers(e){if(!t){for(t=!0;this._allPeers.length;)this._allPeers[0].Remove(e);t=!1}}GetPeerById(e){return this._peersById.get(e)||null}GetAliasFromId(e){const t=this._peersById.get(e);return t?t.GetAlias():""}GetPeerByNid(e){for(const t of this._allPeers)if(t.GetNid()===e)return t;return null}OnHostBroadcast(e){const t=e["fromId"],s=e["tag"],i=e["message"],n=e["transmissionMode"],o=e["contentMode"],r=this.GetPeerById(t);if("s"===o&&i instanceof ArrayBuffer)this.HostBroadcast(n,i,b.FLAG_SCRIPT_DATA,r);else{const a={"c":"m","cm":o,"f":t,"m":i};"e"===o&&(a["t"]=s),this.HostBroadcast(n,JSON.stringify(a),0,r)}}HostBroadcast(e,t,s=0,i=null){if(this.IsHost()){const n=this._allPeers.slice(0);for(const o of n)o&&o!==this._selfPeer&&o!==i&&o.Send(e,t,s)}}_DoPings(){const e=performance.now();if(this.IsHost()){q.push(...this._allPeers);for(const t of q)t&&t!==this._selfPeer&&t.SendPing(e,!1);q.length=0}else this._hostPeer&&this._hostPeer.SendPing(e,!1)}AddRegisteredObject(e){this._allRegisteredObjects.push(e),this._registeredObjectsByRoId.set(e.GetRoId(),e),this._registeredObjectsByNid.set(e.GetNid(),e)}GetRegisteredObjectsMap(){const e={};for(const[t,s]of this._registeredObjectsByNid.entries())e[s.GetSid()]={"nid":t,"nvs":s.GetNetValuesJson()};return e}MapObjectNids(e){this._registeredObjectsByNid.clear();for(const t of this._allRegisteredObjects)if(e.hasOwnProperty(t.GetSid().toString())){const s=e[t.GetSid().toString()];t._SetNid(s["nid"]),this._registeredObjectsByNid.set(s["nid"],t),t.SetNetValuesFrom(s["nvs"])}else console.warn("Could not map object SID '"+t.GetSid()+"' - host did not send NID for it"),t._SetNid(-1)}GetRegisteredObjectByNid(e){return this._registeredObjectsByNid.get(e)||null}Tick(e){if(!this.IsInRoom())return null;const t=e["dt"],s=performance.now(),i=this.IsHost()?this._hostUpdateRateSec:this._peerUpdateRateSec,n=(s-this._lastUpdateTime>=1e3/i-5&&(this.SendUpdate(s),this._lastUpdateTime=s),this._stats),o=(1e3<=s-n.lastSecondTime&&(n.outboundPerSec=n.outboundCount,n.outboundBandwidthPerSec=n.outboundBandwidthCount,n.outboundDecompressedBandwidthPerSec=n.outboundDecompressedBandwidthCount,n.inboundPerSec=n.inboundCount,n.inboundBandwidthPerSec=n.inboundBandwidthCount,n.inboundDecompressedBandwidthPerSec=n.inboundDecompressedBandwidthCount,n.outboundCount=0,n.outboundBandwidthCount=0,n.outboundDecompressedBandwidthCount=0,n.inboundCount=0,n.inboundBandwidthCount=0,n.inboundDecompressedBandwidthCount=0,n.lastSecondTime+=1e3,500<s-n.lastSecondTime&&(n.lastSecondTime=s),this.PostToRuntime("stats",{"stats":{"outboundPerSec":n.outboundPerSec,"outboundBandwidthPerSec":n.outboundBandwidthPerSec,"outboundDecompressedBandwidthPerSec":n.outboundDecompressedBandwidthPerSec,"inboundPerSec":n.inboundPerSec,"inboundBandwidthPerSec":n.inboundBandwidthPerSec,"inboundDecompressedBandwidthPerSec":n.inboundDecompressedBandwidthPerSec}})),this.IsHost()||(this._hostTimeDiff<this._targetHostTimeDiff?(this._hostTimeDiff+=10*t,this._hostTimeDiff>this._targetHostTimeDiff&&(this._hostTimeDiff=this._targetHostTimeDiff)):this._hostTimeDiff>this._targetHostTimeDiff&&(this._hostTimeDiff-=10*t,this._hostTimeDiff<this._targetHostTimeDiff)&&(this._hostTimeDiff=this._targetHostTimeDiff),this._simDelay<this._targetSimDelay?(this._simDelay+=30*t,this._simDelay>this._targetSimDelay&&(this._simDelay=this._targetSimDelay)):this._simDelay>this._targetSimDelay&&(this._simDelay-=30*t,this._simDelay<this._targetSimDelay)&&(this._simDelay=this._targetSimDelay)),this.GetSimulationTime());for(const r of this._allPeers)r.Tick(o);for(const a of this._allRegisteredObjects)a.Tick();return{"simulationTime":this.GetSimulationTime(),"hostInputArrivalTime":this.GetHostInputArrivalTime(),"clientDelay":this._clientDelay,"peerData":this._GetPeerRuntimeData(),"roData":this._GetRegisteredObjectRuntimeData(),"isReadyForInput":this.IsReadyForInput()}}_GetPeerRuntimeData(){const e={};for(const t of this._allPeers){const s={};for(const i of this._allClientValues)s[i.GetTag()]=t.GetInterpClientState(i);e[t.GetId()]={"nid":t.GetNid(),"latency":t.GetLatency(),"pdv":t.GetPdv(),"clientState":s}}return e}_GetRegisteredObjectRuntimeData(){const e={};for(const t of this._allRegisteredObjects)e[t.GetRoId()]=t.GetRuntimeData();return e}async SendUpdate(e){this.IsHost()?(await this._SendHostUpdate(e),this._SendHostEvents(e)):await this._SendClientUpdate(e)}async _OnBeforeClientUpdate(){const e=await this.PostToRuntimeAsync("before-client-update");for(const t of e["clientStateUpdates"])this.SetClientState(t["tag"],t["value"])}async _SendClientUpdate(t){if(this.IsReadyForInput()&&await this._OnBeforeClientUpdate(),this._selfPeer&&this._receivedClientValues){const i=this._dataView;let s=0;const n=this._allClientValues,o=this._selfPeer.GetLocalClientState(),r=t-this._selfPeer.GetLastStateChange(),a=t-this._selfPeer.GetLastStateTransmit();let e=!1;if(e=r<100||(r<1e3?95<=a:495<=a)){i.setFloat64(s,t+this._hostTimeDiff),s+=8,i.setUint8(s,n.length),s+=1;for(let t=0,e=n.length;t<e;++t){const l=n[t];let e=0;t<o.length&&(e=l.Clamp(o[t])),s=l.Write(i,s,e)}this._selfPeer._SetLastStateTransmit(t),this._hostPeer.Send("u",this._dataBuffer.slice(0,s))}}}async _SendHostUpdate(e){const t=this._dataView;let s=0,i=0;const n=await this.PostToRuntimeAsync("get-object-info",{"ros":this._allRegisteredObjects.map(e=>e.GetRuntimeInfoRequest())});for(const o of this._allRegisteredObjects){const r=o.GetRoId();if(n.hasOwnProperty(r)){const a=n[r];o.UpdateData(a,e),0<o.GetNumberToTransmit()&&i++}}if(0!==i){t.setFloat64(s,e),s+=8,t.setUint16(s,i),s+=2;for(const l of this._allRegisteredObjects)0<l.GetNumberToTransmit()&&(s=l.WriteData(t,s,e));this.HostBroadcast("u",this._dataBuffer.slice(0,s),0)}}_SendHostEvents(e){const t=this._dataView;let s=0,i=0;for(const n of this._allRegisteredObjects)n.GetDeadNids().length&&i++;if(0!==i){t.setFloat64(s,e),s+=8,t.setUint16(s,i),s+=2;for(const o of this._allRegisteredObjects){const r=o.GetDeadNids();if(r.length){t.setUint16(s,o.GetNid()),s+=2,t.setUint16(s,r.length),s+=2;for(const a of r)t.setUint16(s,a),s+=2;r.length=0}}this.HostBroadcast("r",this._dataBuffer.slice(0,s),b.FLAG_HOST_UPDATE_TYPE)}}AddHostTime(e,n,o,r){if(!this.IsHost()){this._targetSimDelay=r+this._clientDelay;r=e+o-n;0===this._lastTimeDiffs.length&&(this._hostTimeDiff=r,this._simDelay=this._targetSimDelay),this._lastTimeDiffs.push(r),30<this._lastTimeDiffs.length&&this._lastTimeDiffs.shift(),q.push(...this._lastTimeDiffs),q.sort((e,t)=>e-t);let t=0,s=q.length,i=(4<=q.length&&q.length<=6?(++t,--s):6<q.length&&q.length<=19?(t+=2,s-=2):19<q.length&&(t+=5,s-=5),0);for(let e=t;e<s;++e)i+=q[e];this._targetHostTimeDiff=i/(s-t),q.length=0}}GetSimulationTime(){return this.IsHost()?performance.now()-this._clientDelay:performance.now()+this._hostTimeDiff-this._simDelay}GetHostTime(){return this.IsHost()?performance.now():performance.now()+this._hostTimeDiff}GetHostInputArrivalTime(){return this.IsHost()?performance.now():performance.now()+this._hostTimeDiff+this._simDelay}SetClientState(e,t){if(!this.IsHost()&&this._selfPeer&&this._receivedClientValues){const s=this._clientValuesByTag.get(e);if(s){const i=s.GetIndex(),n=this._selfPeer.GetLocalClientState();n.length<i+1&&(n.length=i+1),n[i]!==t&&(n[i]=t,this._selfPeer._SetLastStateChange(performance.now()))}}}AddClientInputValue(e,t,s){const i=new a(this._allClientValues.length,s,t,e,null);this._clientValuesByTag.set(e,i),this._allClientValues.push(i)}GetClientValues(){return this._allClientValues}GetClientValuesJson(){const e=[];for(const t of this._allClientValues)e.push({"tag":t.GetTag(),"precision":t.GetPrecision(),"interp":t.GetInterp()});return e}MapClientValues(s){this._clientValuesByTag.clear();for(let e=this._allClientValues.length=0,t=s.length;e<t;++e){const i=s[e],n=new a(e,i["interp"],i["precision"],i["tag"],null);this._clientValuesByTag.set(n.GetTag(),n),this._allClientValues.push(n)}this._receivedClientValues=!0}RemoveObjectId(e){for(const t of this._allRegisteredObjects)t.RemoveObjectId(e)}peers(){return this._allPeers}GetPeerCount(){return this.IsInRoom()?this._allPeers.length:0}GetPeerAt(e){return e=Math.floor(e),!this.IsInRoom()||e<0||e>=this._allPeers.length?null:this._allPeers[e]}IsReadyForInput(){return!(!this.IsInRoom()||!this.IsHost()&&0===this._targetHostTimeDiff)}SetBandwidthSettings(e,t){this.IsInRoom()||(this._hostUpdateRateSec=e,this._peerUpdateRateSec=e,this._clientDelay=t)}_OnPeerOpen(e){this.PostToRuntime("peer-open",{"id":e.GetId(),"alias":e.GetAlias()})}OnPeerSendMessage(e){const t=e["id"],s=e["tag"],i=e["message"],n=e["transmissionMode"],o=e["contentMode"],r=this.GetPeerById(t);if(r)if("s"===o&&i instanceof ArrayBuffer)r.Send(n,i,b.FLAG_SCRIPT_DATA);else{const a={"c":"m","cm":o,"m":i};"e"===o&&(a["t"]=s),r.Send(n,JSON.stringify(a))}}_OnPeerClose(e,t){this.PostToRuntime("peer-close",{"id":e.GetId(),"alias":e.GetAlias(),"reason":t||"unknown"})}_OnPeerError(e,t){console.error(`[Multiplayer] Peer '${e.GetAlias()}' (${e.GetId()}) error: `,t)}_OnPeerMessage(e,t,s){const i=t["f"]||e.GetId();this.PostToRuntime("peer-message",{"tag":t["t"],"fromId":i,"fromAlias":this.GetAliasFromId(i),"transmissionMode":s,"content":t["m"],"contentMode":t["cm"]||"e"})}_OnPeerBinaryMessage(e,t,s){const i=e.GetId();this.PostToRuntime("peer-message",{"fromId":i,"fromAlias":this.GetAliasFromId(i),"transmissionMode":s,"content":t,"contentMode":"s"})}_OnInstanceDestroyed(e,t,s){this.PostToRuntime("instance-destroyed",{"roId":e.GetRoId(),"nid":t,"timestamp":s})}OnKickPeer(e){if(this.IsHost()){const t=e["id"],s=e["reason"],i=this.GetPeerById(t);i&&i.Remove(s,!0)}}OnWasKicked(){this.PostToRuntime("peer-kicked")}StatIncOutboundCount(){this._stats.outboundCount++}StatAddOutboundBandwidthCount(e){this._stats.outboundBandwidthCount+=GetDataSize(e)}StatAddOutboundDecompressedBandwidthCount(e){this._stats.outboundDecompressedBandwidthCount+=GetDataSize(e)}StatIncInboundCount(){this._stats.inboundCount++}StatAddInboundBandwidthCount(e){this._stats.inboundBandwidthCount+=GetDataSize(e)}StatAddInboundDecompressedBandwidthCount(e){this._stats.inboundDecompressedBandwidthCount+=GetDataSize(e)}SetClientDelay(e){this._clientDelay=e}GetClientDelay(){return this._clientDelay}SetPeerUpdateRateSec(e){this._peerUpdateRateSec=e}GetPeerUpdateRateSec(){return this._peerUpdateRateSec}OnSyncObject(e){const t=e["x"],s=e["y"],i=e["angle"],r=e["precision"],a=e["bandwidth"];for(const l of e["objectClasses"]){const h=new self.C3RegisteredObject(this,l["roId"],l["sid"],a);t&&h.AddValue(n,r,"x"),s&&h.AddValue(n,r,"y"),i&&h.AddValue(o,r,"a")}}Alert(e){alert(e["message"])}OnSyncInstVar(e){const t=e["precision"],s=e["interp"],i=e["cvt"];for(const n of e["syncData"]){const o=this._registeredObjectsByRoId.get(n["roId"]);o.AddValue(s,t,"iv",n["varIndex"],i)}}OnAssociateObject(e){const t=e["roId"],s=e["peerId"],i=e["instUid"],n=this._registeredObjectsByRoId.get(t),o=this._peersById.get(s);n&&o&&this.IsHost()&&n.OverrideNid(i,o.GetNid())}OnRemoveNetInsts(e){for(const[t,s]of Object.entries(e)){const i=this._registeredObjectsByRoId.get(parseInt(t,10));if(i)for(const n of s)i.RemoveObjectNid(n)}}OnRemoveObjectNid(e){const t=e["roId"],s=e["nid"],i=this._registeredObjectsByRoId.get(t);i&&i.RemoveObjectNid(s)}GetLocalSupportedCompressionFormats(){return l}};self.RuntimeInterface.AddDOMHandlerClass(r)}

// scripts/plugins/Browser/dom/domSide.js
"use strict";{let t=null,n=null;function elemsForSelector(e,t){if(e){if(t)return Array.from(document.querySelectorAll(e));{const n=document.querySelector(e);return n?[n]:[]}}return[document.documentElement]}function noop(){}window.addEventListener("beforeinstallprompt",e=>(e.preventDefault(),t=e,n&&n._OnBeforeInstallPrompt(),!1));const c="browser",d=class extends self.DOMHandler{constructor(e){super(e,c),this._exportType="",this.AddRuntimeMessageHandlers([["get-initial-state",e=>this._OnGetInitialState(e)],["ready-for-sw-messages",()=>this._OnReadyForSWMessages()],["alert",e=>this._OnAlert(e)],["close",()=>this._OnClose()],["set-focus",e=>this._OnSetFocus(e)],["vibrate",e=>this._OnVibrate(e)],["lock-orientation",e=>this._OnLockOrientation(e)],["unlock-orientation",()=>this._OnUnlockOrientation()],["navigate",e=>this._OnNavigate(e)],["request-fullscreen",e=>this._OnRequestFullscreen(e)],["exit-fullscreen",()=>this._OnExitFullscreen()],["set-hash",e=>this._OnSetHash(e)],["set-document-css-style",e=>this._OnSetDocumentCSSStyle(e)],["get-document-css-style",e=>this._OnGetDocumentCSSStyle(e)],["set-window-size",e=>this._OnSetWindowSize(e)],["set-window-position",e=>this._OnSetWindowPosition(e)],["request-install",()=>this._OnRequestInstall()],["set-warn-on-close",e=>this._OnSetWarnOnClose(e)]]),window.addEventListener("online",()=>this._OnOnlineStateChanged(!0)),window.addEventListener("offline",()=>this._OnOnlineStateChanged(!1)),window.addEventListener("hashchange",()=>this._OnHashChange()),this._beforeunload_handler=e=>e.preventDefault(),document.addEventListener("backbutton",()=>this._OnCordovaBackButton())}Attach(){t?this._OnBeforeInstallPrompt():n=this,window.addEventListener("appinstalled",()=>this._OnAppInstalled())}_OnGetInitialState(e){return this._exportType=e["exportType"],{"location":location.toString(),"isOnline":!!navigator.onLine,"referrer":document.referrer,"title":document.title,"isCookieEnabled":!!navigator.cookieEnabled,"screenWidth":screen.width,"screenHeight":screen.height,"windowOuterWidth":window.outerWidth,"windowOuterHeight":window.outerHeight,"isConstructArcade":void 0!==window["is_scirra_arcade"]}}_OnReadyForSWMessages(){window["C3_RegisterSW"]&&window["OfflineClientInfo"]&&window["OfflineClientInfo"]["SetMessageCallback"](e=>this.PostToRuntime("sw-message",e["data"]))}_OnBeforeInstallPrompt(){this.PostToRuntime("install-available")}async _OnRequestInstall(){if(!t)return{"result":"unavailable"};try{t["prompt"]();const e=await t["userChoice"];return{"result":e["outcome"]}}catch(e){return console.error("[Construct] Requesting install failed: ",e),{"result":"failed"}}}_OnAppInstalled(){this.PostToRuntime("app-installed")}_OnOnlineStateChanged(e){this.PostToRuntime("online-state",{"isOnline":e})}_OnCordovaBackButton(){this.PostToRuntime("backbutton")}GetNWjsWindow(){return"nwjs"===this._exportType?nw["Window"]["get"]():null}_OnAlert(e){alert(e["message"])}_OnClose(){navigator["app"]&&navigator["app"]["exitApp"]?navigator["app"]["exitApp"]():navigator["device"]&&navigator["device"]["exitApp"]?navigator["device"]["exitApp"]():self["nw"]?self["nw"]["App"]["quit"]():window.close()}_OnSetFocus(e){const t=e["isFocus"];if("nwjs"===this._exportType){const n=this.GetNWjsWindow();t?n["focus"]():n["blur"]()}else t?window.focus():window.blur()}_OnVibrate(e){navigator["vibrate"]&&navigator["vibrate"](e["pattern"])}_OnLockOrientation(e){const t=e["orientation"];if(screen["orientation"]&&screen["orientation"]["lock"])screen["orientation"]["lock"](t).catch(e=>console.warn("[Construct] Failed to lock orientation: ",e));else try{let e=!1;screen["lockOrientation"]?e=screen["lockOrientation"](t):screen["webkitLockOrientation"]?e=screen["webkitLockOrientation"](t):screen["mozLockOrientation"]?e=screen["mozLockOrientation"](t):screen["msLockOrientation"]&&(e=screen["msLockOrientation"](t)),e||console.warn("[Construct] Failed to lock orientation")}catch(e){console.warn("[Construct] Failed to lock orientation: ",e)}}_OnUnlockOrientation(){try{screen["orientation"]&&screen["orientation"]["unlock"]?screen["orientation"]["unlock"]():screen["unlockOrientation"]?screen["unlockOrientation"]():screen["webkitUnlockOrientation"]?screen["webkitUnlockOrientation"]():screen["mozUnlockOrientation"]?screen["mozUnlockOrientation"]():screen["msUnlockOrientation"]&&screen["msUnlockOrientation"]()}catch(e){}}_OnNavigate(e){const t=e["type"];if("back"===t)navigator["app"]&&navigator["app"]["backHistory"]?navigator["app"]["backHistory"]():window.history.back();else if("forward"===t)window.history.forward();else if("reload"===t)location.reload();else if("url"===t){const n=e["url"],o=e["target"],i=e["exportType"];self["cordova"]&&self["cordova"]["InAppBrowser"]?self["cordova"]["InAppBrowser"]["open"](n,"_system"):"preview"===i||"linux-cef"===i||this._iRuntime.IsAnyWebView2Wrapper()?window.open(n,"_blank"):this._isConstructArcade||(2===o?window.top.location=n:1===o?window.parent.location=n:window.location=n)}else if("new-window"===t){const s=e["url"],r=e["tag"];self["cordova"]&&self["cordova"]["InAppBrowser"]?self["cordova"]["InAppBrowser"]["open"](s,"_system"):window.open(s,r)}}_OnRequestFullscreen(t){if(this._iRuntime.IsAnyWebView2Wrapper()||"macos-wkwebview"===this._exportType||"linux-cef"===this._exportType)self.RuntimeInterface._SetWrapperIsFullscreenFlag(!0),this._iRuntime._SendWrapperMessage({"type":"set-fullscreen","fullscreen":!0});else{const n={"navigationUI":"auto"},o=t["navUI"],i=(1===o?n["navigationUI"]="hide":2===o&&(n["navigationUI"]="show"),document.documentElement);let e;i["requestFullscreen"]?e=i["requestFullscreen"](n):i["mozRequestFullScreen"]?e=i["mozRequestFullScreen"](n):i["msRequestFullscreen"]?e=i["msRequestFullscreen"](n):i["webkitRequestFullScreen"]&&(e=void 0!==Element["ALLOW_KEYBOARD_INPUT"]?i["webkitRequestFullScreen"](Element["ALLOW_KEYBOARD_INPUT"]):i["webkitRequestFullScreen"]()),e instanceof Promise&&e.catch(noop)}}_OnExitFullscreen(){if(this._iRuntime.IsAnyWebView2Wrapper()||"macos-wkwebview"===this._exportType||"linux-cef"===this._exportType)self.RuntimeInterface._SetWrapperIsFullscreenFlag(!1),this._iRuntime._SendWrapperMessage({"type":"set-fullscreen","fullscreen":!1});else{let e;document["exitFullscreen"]?e=document["exitFullscreen"]():document["mozCancelFullScreen"]?e=document["mozCancelFullScreen"]():document["msExitFullscreen"]?e=document["msExitFullscreen"]():document["webkitCancelFullScreen"]&&(e=document["webkitCancelFullScreen"]()),e instanceof Promise&&e.catch(noop)}}_OnSetHash(e){location.hash=e["hash"]}_OnHashChange(){this.PostToRuntime("hashchange",{"location":location.toString()})}_OnSetDocumentCSSStyle(e){const t=e["prop"],n=e["value"],o=e["selector"],i=e["is-all"];try{const s=elemsForSelector(o,i);for(const e of s)t.startsWith("--")?e.style.setProperty(t,n):e.style[t]=n}catch(e){console.warn("[Browser] Failed to set style: ",e)}}_OnGetDocumentCSSStyle(e){const t=e["prop"],n=e["selector"];try{const o=document.querySelector(n);if(o){const i=window.getComputedStyle(o);return{"isOk":!0,"result":i.getPropertyValue(t)}}return{"isOk":!1}}catch(e){return console.warn("[Browser] Failed to get style: ",e),{"isOk":!1}}}_OnSetWindowSize(e){window.resizeTo(e["windowWidth"],e["windowHeight"])}_OnSetWindowPosition(e){window.moveTo(e["windowX"],e["windowY"])}_OnSetWarnOnClose(e){const t=e["enabled"];t?window.addEventListener("beforeunload",this._beforeunload_handler):window.removeEventListener("beforeunload",this._beforeunload_handler)}};self.RuntimeInterface.AddDOMHandlerClass(d)}

// start-export.js
"use strict";if(window["C3_Is_Supported"]){const a=true;window["c3_runtimeInterface"]=new self.RuntimeInterface({useWorker:a,workerMainUrl:"workermain.js",runtimeScriptList:["scripts/c3main.js"],scriptFolder:"scripts/",exportType:"html5"})}
